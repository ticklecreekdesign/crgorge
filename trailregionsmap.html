<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Columbia River Gorge — Region Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{
      height:100%;width:100%;margin:0;padding:0;
      font-family:Montserrat,sans-serif;color:#333;font-size:13px;
    }
    .container{
      display:flex;
      width:100%;
      height:100%;
    }
    .map-column{
      flex:1;
      position:relative;
    }
    #map{
      position:absolute;
      top:0;left:0;right:0;bottom:0;
    }
    .legend-column{
      width:270px;
      background:#fff;
      border-left:1px solid #ddd;
      padding:10px 14px 14px 14px;
      overflow-y:auto;
      line-height:1.45;
      box-sizing:border-box;
    }
    .legend-column h3{margin:0 0 16px 0;font-size:15px;font-weight:600;}
    .region-entry{margin:12px 0 20px 0;}
    .region-link{
      text-decoration:none;font-weight:700;font-size:17px;
      display:inline-block;margin-bottom:3px;cursor:pointer;
    }
    .region-link:hover{opacity:0.75;}
    .region-meta{margin-left:2px;color:#555;}
    .region-meta div{margin:2px 0;}
    .legend-detail .back-row{position:sticky;top:0;background:#fff;padding:6px 0 8px 0;z-index:2;}
    .legend-detail .back-link{color:#06c;text-decoration:none;font-weight:600;cursor:pointer;}
    .legend-detail .back-link:hover{text-decoration:underline;}
    .legend-detail h3{font-size:18px;font-weight:700;margin:8px 0 8px 0;}
    .trail-list{margin:10px 0 0 0;padding-left:18px;list-style-type:disc;}
    .trail-list li{margin:3px 0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="map-column">
      <div id="map"></div>
    </div>
    <div class="legend-column" id="legend"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    var gorge = {};
    
    gorge.DEFAULT_CENTER = [45.6746, -121.8794];
    gorge.DEFAULT_ZOOM = 10;

    gorge.REGION_INFO = {
      west:{label:'West',color:'#1B5E20',area:'Troutdale → Bridal Veil area',mm:'17–28',
        highlights:'Waterfalls and short scenic hikes; historic Columbia River Highway viewpoints; lush mossy forests; easy access from Portland; family-friendly trails like Latourell and Bridal Veil Falls.'},
      centralwest:{label:'Central West',color:'#2E7D32',area:'Wahkeena → Cascade Locks',mm:'28–41',
        highlights:'Iconic waterfall corridor (Multnomah, Wahkeena, Horsetail); steep canyon hikes with sweeping vistas; Benson Bridge photo stops; Gorge Trail 400 connections; picnic areas and visitor centers.'},
      central:{label:'Central',color:'#558B2F',area:'Cascade Locks → Starvation Creek',mm:'41–55',
        highlights:'Forest climbs and summit routes (Hamilton Mountain, Table Mountain, Dog Mountain); panoramic viewpoints; Pacific Crest Trail crossings; windsurfing at Bridge of the Gods; spring wildflowers.'},
      centraleast:{label:'Central East',color:'#9E9D24',area:'Starvation Creek → Mosier',mm:'55–67',
        highlights:'Steep basalt cliffs and open hillsides; scenic drives with river overlooks; lesser-traveled trails like McCall Point and Coyote Wall; spring wildflowers; transition zone between rainforest and grassland.'},
      east:{label:'East',color:'#C0CA33',area:'Mosier → The Dalles and beyond',mm:'60–90',
        highlights:'Drier climate with high-desert scenery; oak woodlands and wide-open ridges; wildflower plateaus; biking and wine-tasting routes near Rowena and Mosier; sunny weather and sweeping Gorge views.'}
    };

    gorge.TRAILS = {
      "West":["Angels' Rest","Angels' Rest to Devil's Rest","Bridal Veil Falls","Bridal Veil Loop","Fairy Falls","Larch Mt via Multnomah Falls","Latourell Falls Trail","Multnomah Falls","Multnomah–Wahkeena Loop","Rooster Rock Loop","Sandy River Delta","Shepperd's Dell","Wahkeena Falls"],
      "Central West":["Bell Creek Trail","Eagle Creek Trail","Elowah Falls","Horsetail Falls Loop","Indian Point Loop","John B. Yeon Trailhead","Munra Point","Nesmith Point Trail","Oneonta Gorge","Ponytail Falls Trail","Punchbowl Falls","Triple Falls Trail","Tunnel Falls","Upper McCord Creek Falls","Wauna Point"],
      "Central":["Bonneville Dam Trail","Bridge Of The Gods Trailhead","Cascade Locks Trail","Dry Creek Falls","Hamilton Mountain Loop","Hardy Ridge Loop","Herman Creek Pinnacles","Nick Eaton Ridge Loop","Ruckel Ridge Loop","Table Mountain Loop","Tom McCall Point","Wahclella Falls"],
      "Central East":["Chetwoot Loop Hike","Lancaster Falls","Lower Starvation Loop","Mark O. Hatfield Trailhead","Memaloose Hills","Mitchell Point Trail","Mosier Twin Tunnels","Mt. Defiance Loop","Rowena Plateau","Starvation Creek Trail","Starvation Ridge","Tooth Rock Loop","Wygant Peak"],
      "East":["Augspurger Mountain Trail","Beacon Rock Trail","Cape Horn Loop Trail","Catherine Creek Arch Loop","Columbia Hills State Park","Coyote Wall","Deschutes River Trail","Dog Mountain","Gillette Lake","Horsethief Butte Trail","Klickitat Rail Trail","Labyrinth / Syncline","Lyle Cherry Orchard","Sevenmile Hill","Steigerwald Lake Trail","The Dalles Mountain","Wind Mountain"]
    };

    gorge.REGION_CENTER_LAT = {
      west:45.55,
      centralwest:45.58,
      central:45.655,
      centraleast:45.685,
      east:45.68
    };

    gorge.baseHalf = 0.045;
    gorge.slices = {
      west:{minLon:-122.50,maxLon:-122.25},
      centralwest:{minLon:-122.25,maxLon:-122.00},
      central:{minLon:-122.00,maxLon:-121.75},
      centraleast:{minLon:-121.75,maxLon:-121.50},
      east:{minLon:-121.50,maxLon:-121.25}
    };

    gorge.regions = {};
    gorge.baseCoords = {};
    gorge.regionLayers = {};
    gorge.regionLabels = {};
    
    gorge.init = function() {
      gorge.map = L.map('map').setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);

      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
        { attribution: '&copy; Esri, USGS, NOAA, U.S. Navy, NGA, GEBCO' }
      ).addTo(gorge.map);

      gorge.legend = document.getElementById('legend');
      
      gorge.createRegions();
      gorge.setupEventListeners();
      gorge.renderGuide();
    };

    gorge.rectCoordsFor = function(key, minLon, maxLon, half) {
      var c = gorge.REGION_CENTER_LAT[key];
      return [[c+half,minLon],[c+half,maxLon],[c-half,maxLon],[c-half,minLon]];
    };

    gorge.createRegions = function() {
      var borderColor = '#666';
      
      for(var k in gorge.slices) {
        var i = gorge.REGION_INFO[k];
        var s = gorge.slices[k];
        var coords = gorge.rectCoordsFor(k, s.minLon, s.maxLon, gorge.baseHalf);
        gorge.baseCoords[k] = coords.slice();
        
        gorge.regionLayers[k] = [];
        
        var fadeSteps = 5;
        var fadeExtensionLat = 0.03;
        var fadeExtensionLon = 0.04;
        var centerLat = gorge.REGION_CENTER_LAT[k];
        
        // Fade above (top edge)
        for(var step = 1; step <= fadeSteps; step++) {
          var topStart = centerLat + gorge.baseHalf + (fadeExtensionLat * (step - 1));
          var topEnd = centerLat + gorge.baseHalf + (fadeExtensionLat * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [topEnd, s.minLon],
            [topEnd, s.maxLon],
            [topStart, s.maxLon],
            [topStart, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade below (bottom edge)
        for(var step = 1; step <= fadeSteps; step++) {
          var bottomStart = centerLat - gorge.baseHalf - (fadeExtensionLat * (step - 1));
          var bottomEnd = centerLat - gorge.baseHalf - (fadeExtensionLat * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [bottomStart, s.minLon],
            [bottomStart, s.maxLon],
            [bottomEnd, s.maxLon],
            [bottomEnd, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade left (left edge with border)
        for(var step = 1; step <= fadeSteps; step++) {
          var leftStart = s.minLon - (fadeExtensionLon * (step - 1));
          var leftEnd = s.minLon - (fadeExtensionLon * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [centerLat + gorge.baseHalf, leftStart],
            [centerLat + gorge.baseHalf, leftEnd],
            [centerLat - gorge.baseHalf, leftEnd],
            [centerLat - gorge.baseHalf, leftStart]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade right (right edge with border)
        for(var step = 1; step <= fadeSteps; step++) {
          var rightStart = s.maxLon + (fadeExtensionLon * (step - 1));
          var rightEnd = s.maxLon + (fadeExtensionLon * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [centerLat + gorge.baseHalf, rightStart],
            [centerLat + gorge.baseHalf, rightEnd],
            [centerLat - gorge.baseHalf, rightEnd],
            [centerLat - gorge.baseHalf, rightStart]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Create fading vertical border lines on left and right
        var borderSteps = 10;
        var totalHeight = gorge.baseHalf * 2 + (fadeExtensionLat * fadeSteps * 2);
        var startLat = centerLat - gorge.baseHalf - (fadeExtensionLat * fadeSteps);
        
        // Left border line
        for(var bstep = 0; bstep < borderSteps; bstep++) {
          var latStart = startLat + (totalHeight * bstep / borderSteps);
          var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
            color: borderColor,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Right border line
        for(var bstep = 0; bstep < borderSteps; bstep++) {
          var latStart = startLat + (totalHeight * bstep / borderSteps);
          var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
            color: borderColor,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Main region (interactive, no border)
        gorge.regions[k] = L.polygon(coords, {
          color: 'transparent',
          fillColor: i.color,
          weight: 0,
          fillOpacity: 0.35
        }).addTo(gorge.map);
        
        // Add region label
        var labelIcon = L.divIcon({
          className: 'region-label',
          html: '<div style="font-size:16px;font-weight:700;color:'+i.color+';text-shadow:1px 1px 2px rgba(255,255,255,0.9), -1px -1px 2px rgba(255,255,255,0.9), 1px -1px 2px rgba(255,255,255,0.9), -1px 1px 2px rgba(255,255,255,0.9);white-space:nowrap;">'+i.label+'</div>',
          iconSize: [0, 0]
        });
        
        gorge.regionLabels[k] = L.marker([centerLat, (s.minLon + s.maxLon) / 2], {
          icon: labelIcon,
          interactive: false
        }).addTo(gorge.map);
      }
    };

    gorge.extraHalfHeight = function(count) {
      return Math.min(0.12, (count/6)*0.002);
    };
    
    gorge.expandRegion = function(k) {
      var i = gorge.REGION_INFO[k];
      var s = gorge.slices[k];
      var count = (gorge.TRAILS[i.label] || []).length;
      var half = gorge.baseHalf + gorge.extraHalfHeight(count);
      
      // Remove old fade/border layers
      for(var j = 0; j < gorge.regionLayers[k].length; j++) {
        gorge.map.removeLayer(gorge.regionLayers[k][j]);
      }
      gorge.regionLayers[k] = [];
      
      // Recreate fade and border layers with new height
      var borderColor = '#666';
      var fadeSteps = 5;
      var fadeExtensionLat = 0.03;
      var fadeExtensionLon = 0.04;
      var centerLat = gorge.REGION_CENTER_LAT[k];
      
      // Fade above
      for(var step = 1; step <= fadeSteps; step++) {
        var topStart = centerLat + half + (fadeExtensionLat * (step - 1));
        var topEnd = centerLat + half + (fadeExtensionLat * step);
        var opacity = 0.35 - (0.35 * (step / fadeSteps));
        
        var layer = L.polygon([
          [topEnd, s.minLon],
          [topEnd, s.maxLon],
          [topStart, s.maxLon],
          [topStart, s.minLon]
        ], {
          color: 'transparent',
          fillColor: i.color,
          weight: 0,
          fillOpacity: opacity,
          interactive: false
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Fade below
      for(var step = 1; step <= fadeSteps; step++) {
        var bottomStart = centerLat - half - (fadeExtensionLat * (step - 1));
        var bottomEnd = centerLat - half - (fadeExtensionLat * step);
        var opacity = 0.35 - (0.35 * (step / fadeSteps));
        
        var layer = L.polygon([
          [bottomStart, s.minLon],
          [bottomStart, s.maxLon],
          [bottomEnd, s.maxLon],
          [bottomEnd, s.minLon]
        ], {
          color: 'transparent',
          fillColor: i.color,
          weight: 0,
          fillOpacity: opacity,
          interactive: false
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Fade left
      for(var step = 1; step <= fadeSteps; step++) {
        var leftStart = s.minLon - (fadeExtensionLon * (step - 1));
        var leftEnd = s.minLon - (fadeExtensionLon * step);
        var opacity = 0.35 - (0.35 * (step / fadeSteps));
        
        var layer = L.polygon([
          [centerLat + half, leftStart],
          [centerLat + half, leftEnd],
          [centerLat - half, leftEnd],
          [centerLat - half, leftStart]
        ], {
          color: 'transparent',
          fillColor: i.color,
          weight: 0,
          fillOpacity: opacity,
          interactive: false
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Fade right
      for(var step = 1; step <= fadeSteps; step++) {
        var rightStart = s.maxLon + (fadeExtensionLon * (step - 1));
        var rightEnd = s.maxLon + (fadeExtensionLon * step);
        var opacity = 0.35 - (0.35 * (step / fadeSteps));
        
        var layer = L.polygon([
          [centerLat + half, rightStart],
          [centerLat + half, rightEnd],
          [centerLat - half, rightEnd],
          [centerLat - half, rightStart]
        ], {
          color: 'transparent',
          fillColor: i.color,
          weight: 0,
          fillOpacity: opacity,
          interactive: false
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Recreate border lines
      var borderSteps = 10;
      var totalHeight = half * 2 + (fadeExtensionLat * fadeSteps * 2);
      var startLat = centerLat - half - (fadeExtensionLat * fadeSteps);
      
      // Left border
      for(var bstep = 0; bstep < borderSteps; bstep++) {
        var latStart = startLat + (totalHeight * bstep / borderSteps);
        var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
        var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
        var maxDist = half + (fadeExtensionLat * fadeSteps);
        var borderOpacity = 1 - (distFromCenter / maxDist);
        borderOpacity = Math.max(0, Math.min(1, borderOpacity));
        
        var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
          color: borderColor,
          weight: 2,
          opacity: borderOpacity
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Right border
      for(var bstep = 0; bstep < borderSteps; bstep++) {
        var latStart = startLat + (totalHeight * bstep / borderSteps);
        var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
        var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
        var maxDist = half + (fadeExtensionLat * fadeSteps);
        var borderOpacity = 1 - (distFromCenter / maxDist);
        borderOpacity = Math.max(0, Math.min(1, borderOpacity));
        
        var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
          color: borderColor,
          weight: 2,
          opacity: borderOpacity
        }).addTo(gorge.map);
        gorge.regionLayers[k].push(layer);
      }
      
      // Update main region
      gorge.regions[k].setLatLngs(gorge.rectCoordsFor(k, s.minLon, s.maxLon, half));
      gorge.regions[k].setStyle({fillOpacity: 0.55});
    };
    
    gorge.resetBands = function() {
      for(var k in gorge.regions) {
        // Remove old fade/border layers
        for(var j = 0; j < gorge.regionLayers[k].length; j++) {
          gorge.map.removeLayer(gorge.regionLayers[k][j]);
        }
        gorge.regionLayers[k] = [];
        
        // Recreate with original dimensions
        var i = gorge.REGION_INFO[k];
        var s = gorge.slices[k];
        var borderColor = '#666';
        var fadeSteps = 5;
        var fadeExtensionLat = 0.03;
        var fadeExtensionLon = 0.04;
        var centerLat = gorge.REGION_CENTER_LAT[k];
        
        // Fade above
        for(var step = 1; step <= fadeSteps; step++) {
          var topStart = centerLat + gorge.baseHalf + (fadeExtensionLat * (step - 1));
          var topEnd = centerLat + gorge.baseHalf + (fadeExtensionLat * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [topEnd, s.minLon],
            [topEnd, s.maxLon],
            [topStart, s.maxLon],
            [topStart, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade below
        for(var step = 1; step <= fadeSteps; step++) {
          var bottomStart = centerLat - gorge.baseHalf - (fadeExtensionLat * (step - 1));
          var bottomEnd = centerLat - gorge.baseHalf - (fadeExtensionLat * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [bottomStart, s.minLon],
            [bottomStart, s.maxLon],
            [bottomEnd, s.maxLon],
            [bottomEnd, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade left
        for(var step = 1; step <= fadeSteps; step++) {
          var leftStart = s.minLon - (fadeExtensionLon * (step - 1));
          var leftEnd = s.minLon - (fadeExtensionLon * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [centerLat + gorge.baseHalf, leftStart],
            [centerLat + gorge.baseHalf, leftEnd],
            [centerLat - gorge.baseHalf, leftEnd],
            [centerLat - gorge.baseHalf, leftStart]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Fade right
        for(var step = 1; step <= fadeSteps; step++) {
          var rightStart = s.maxLon + (fadeExtensionLon * (step - 1));
          var rightEnd = s.maxLon + (fadeExtensionLon * step);
          var opacity = 0.35 - (0.35 * (step / fadeSteps));
          
          var layer = L.polygon([
            [centerLat + gorge.baseHalf, rightStart],
            [centerLat + gorge.baseHalf, rightEnd],
            [centerLat - gorge.baseHalf, rightEnd],
            [centerLat - gorge.baseHalf, rightStart]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Recreate border lines
        var borderSteps = 10;
        var totalHeight = gorge.baseHalf * 2 + (fadeExtensionLat * fadeSteps * 2);
        var startLat = centerLat - gorge.baseHalf - (fadeExtensionLat * fadeSteps);
        
        // Left border
        for(var bstep = 0; bstep < borderSteps; bstep++) {
          var latStart = startLat + (totalHeight * bstep / borderSteps);
          var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
            color: borderColor,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Right border
        for(var bstep = 0; bstep < borderSteps; bstep++) {
          var latStart = startLat + (totalHeight * bstep / borderSteps);
          var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
            color: borderColor,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          gorge.regionLayers[k].push(layer);
        }
        
        // Reset main region
        gorge.regions[k].setLatLngs(gorge.baseCoords[k]);
        gorge.regions[k].setStyle({fillOpacity: 0.35});
      }
    };

    gorge.escapeHTML = function(s) {
      var div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    };

    gorge.renderGuide = function() {
      gorge.legend.className = 'legend-column';
      var html = '<h3>Region Guide</h3>';
      for(var k in gorge.REGION_INFO) {
        var i = gorge.REGION_INFO[k];
        html += '<div class="region-entry"><a class="region-link" style="color:'+i.color+';" data-region="'+k+'">'+i.label+'</a><div class="region-meta"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div></div></div>';
      }
      gorge.legend.innerHTML = html;
      
      var links = gorge.legend.querySelectorAll('.region-link');
      for(var i=0; i<links.length; i++) {
        links[i].onclick = function() {
          gorge.showRegion(this.getAttribute('data-region'));
        };
      }
      
      gorge.map.setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);
    };

    gorge.renderRegionDetail = function(k) {
      var i = gorge.REGION_INFO[k];
      var trails = (gorge.TRAILS[i.label] || []).slice().sort(function(a,b){return a.localeCompare(b);});
      gorge.legend.className = 'legend-column legend-detail';
      var html = '<div class="back-row"><a class="back-link" id="backLink">← Back to Region Guide</a></div><h3 style="color:'+i.color+';">'+i.label+'</h3><div style="color:#555;margin-bottom:8px;"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div><div><strong>Highlights:</strong> '+i.highlights+'</div></div><ul class="trail-list">';
      for(var j=0; j<trails.length; j++) {
        html += '<li>'+gorge.escapeHTML(trails[j])+'</li>';
      }
      html += '</ul>';
      gorge.legend.innerHTML = html;
      
      document.getElementById('backLink').onclick = function() {
        gorge.backToGuide();
      };
    };

    gorge.showRegion = function(k) {
      gorge.resetBands();
      gorge.expandRegion(k);
      gorge.renderRegionDetail(k);
      gorge.map.fitBounds(gorge.regions[k].getBounds(), {padding: [20, 20]});
    };
    
    gorge.backToGuide = function() {
      gorge.resetBands();
      gorge.renderGuide();
    };

    gorge.setupEventListeners = function() {
      gorge.map.on('click', function() {
        gorge.backToGuide();
      });
      
      for(var k in gorge.regions) {
        (function(key) {
          gorge.regions[key].on('click', function(e) {
            L.DomEvent.stopPropagation(e);
            gorge.showRegion(key);
          });
        })(k);
      }
    };

    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', gorge.init);
    } else {
      gorge.init();
    }
  </script>
</body>
</html>
