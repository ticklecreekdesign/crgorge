<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Columbia River Gorge — Region Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Montserrat, sans-serif;
      color: #333;
      font-size: 13px;
    }
    #map { width: 100%; height: 100%; }

    /* Right-side legend */
    .legend {
      position: absolute;
      top: 0; right: 0;
      z-index: 1000;
      background: #fff;
      border-left: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      width: 270px;
      max-height: 100%;
      padding: 10px 14px 14px 14px;
      overflow-y: auto; /* whole panel scrolls as one block */
      line-height: 1.4;
    }
    .legend h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
    }
    .region-item { display: flex; align-items: center; margin: 4px 0; }
    .color-box {
      width: 12px; height: 12px; margin-right: 8px; border: 1px solid #ccc;
    }
    .region-link { color: #0066cc; text-decoration: none; }
    .region-link:hover { text-decoration: underline; }

    /* Highlights */
    .highlights { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 8px; }
    .highlights h4 { margin: 0 0 6px 0; font-size: 14px; font-weight: 600; }
    .highlights p { margin: 8px 0; }
    .highlights em { color: #666; }
    .highlights span { color: #555; }

    /* Popup trail list styling */
    .popup-wrap { max-height: 220px; overflow-y: auto; }
    .popup-wrap h4 { margin: 0 0 6px 0; font-size: 14px; }
    .trail-list { margin: 0; padding-left: 18px; }
    .trail-list li { margin: 2px 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend" id="legend">
    <h3>Region Guide</h3>

    <div class="region-item">
      <div class="color-box" style="background:#4a90e2;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('west'); return false;">West</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#7ed321;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('centralwest'); return false;">Central West</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#f8e71c;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('central'); return false;">Central</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#f5a623;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('centraleast'); return false;">Central East</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#d0021b;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('east'); return false;">East</a>
    </div>

    <div class="highlights">
      <h4>Region Highlights</h4>

      <p><strong>West</strong><br>
      <em>Troutdale → Bridal Veil area</em><br>
      <span>I-84 Mile Markers (approx): 17–28</span><br>
      Waterfalls and short scenic hikes; historic Columbia River Highway viewpoints; lush mossy forests; easy access from Portland; family-friendly trails like Latourell and Bridal Veil Falls.</p>

      <p><strong>Central West</strong><br>
      <em>Wahkeena → Cascade Locks</em><br>
      <span>I-84 Mile Markers (approx): 28–41</span><br>
      Iconic waterfall corridor (Multnomah, Wahkeena, Horsetail); steep canyon hikes with sweeping vistas; Benson Bridge photo stops; Gorge Trail 400 connections; picnic areas and visitor centers.</p>

      <p><strong>Central</strong><br>
      <em>Cascade Locks → Starvation Creek</em><br>
      <span>I-84 Mile Markers (approx): 41–55</span><br>
      Forest climbs and summit routes (Hamilton Mountain, Table Mountain, Dog Mountain); panoramic viewpoints; Pacific Crest Trail crossings; windsurfing at Bridge of the Gods; spring wildflowers.</p>

      <p><strong>Central East</strong><br>
      <em>Starvation Creek → Mosier</em><br>
      <span>I-84 Mile Markers (approx): 55–67</span><br>
      Steep basalt cliffs and open hillsides; scenic drives with river overlooks; lesser-traveled trails like McCall Point and Coyote Wall; spring wildflowers; transition zone between rainforest and grassland.</p>

      <p><strong>East</strong><br>
      <em>Mosier → The Dalles and beyond</em><br>
      <span>I-84 Mile Markers (approx): 60–90</span><br>
      Drier climate with high-desert scenery; oak woodlands and wide-open ridges; wildflower plateaus; biking and wine-tasting routes near Rowena and Mosier; sunny weather and sweeping Gorge views.</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map setup ---
    const map = L.map('map', { center: [45.68, -121.8], zoom: 9.45 });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Region band geometry ---
    // Narrow north/south extent centered on the river (~45.70°N)
    // Adjust the latBandHalfWidth if you want thinner/thicker stripes.
    const latCenter = 45.70;
    const latBandHalfWidth = 0.05; // ~5-6 km north/south coverage around the river
    const topLat = latCenter + latBandHalfWidth;   // ~45.75
    const botLat = latCenter - latBandHalfWidth;   // ~45.65

    // Longitudinal slices (west -> east)
    // Tuned to roughly match: West, Central West, Central, Central East, East
    const lonSlices = {
      west:       { minLon: -122.50, maxLon: -122.25, color: '#4a90e2' },
      centralwest:{ minLon: -122.25, maxLon: -122.00, color: '#7ed321' },
      central:    { minLon: -122.00, maxLon: -121.75, color: '#f8e71c' },
      centraleast:{ minLon: -121.75, maxLon: -121.50, color: '#f5a623' },
      east:       { minLon: -121.50, maxLon: -121.25, color: '#d0021b' }
    };

    // Create region layers and store for zoom
    const regions = {};
    Object.keys(lonSlices).forEach(key => {
      const { minLon, maxLon, color } = lonSlices[key];
      const poly = L.polygon([
        [topLat,  minLon],
        [topLat,  maxLon],
        [botLat,  maxLon],
        [botLat,  minLon]
      ], { color, weight: 1, fillOpacity: 0.25 });
      poly.addTo(map);
      regions[key] = poly;
    });

    function zoomToRegion(regionKey) {
      const layer = regions[regionKey];
      if (layer) map.fitBounds(layer.getBounds(), { padding: [20, 20] });
    }

    // --- Trails loading from CSV ---
    // Place your CSV in the same folder and name it exactly:
    //   trails_by_region.csv
    // Expected minimal headers (case-insensitive):
    //   Trail, Region
    // Region values must be one of:
    //   West, Central West, Central, Central East, East
    const CSV_URL = 'trails_by_region.csv';

    // Build a dictionary like { "West": [ "Trail A", "Trail B", ... ], ... }
    const TRAILS_BY_REGION_FALLBACK = {
      // Fallback stays empty; once you upload CSV, it will populate automatically.
      'West': [],
      'Central West': [],
      'Central': [],
      'Central East': [],
      'East': []
    };

    const TRAILS_BY_REGION = JSON.parse(JSON.stringify(TRAILS_BY_REGION_FALLBACK));

    // Simple CSV parser (handles basic CSV; for complex fields, consider refining)
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const header = lines[0].split(',').map(h => h.trim().toLowerCase());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        let line = lines[i];
        // Basic quoted field support
        const fields = [];
        let cur = '';
        let inQuotes = false;
        for (let c = 0; c < line.length; c++) {
          const ch = line[c];
          if (ch === '"' ) {
            if (inQuotes && line[c+1] === '"') { cur += '"'; c++; }
            else { inQuotes = !inQuotes; }
          } else if (ch === ',' && !inQuotes) {
            fields.push(cur.trim());
            cur = '';
          } else {
            cur += ch;
          }
        }
        fields.push(cur.trim());

        const obj = {};
        header.forEach((h, idx) => { obj[h] = (fields[idx] || '').trim(); });
        rows.push(obj);
      }
      return rows;
    }

    function normalizeRegionName(rgn) {
      const v = (rgn || '').toLowerCase().trim();
      if (v === 'west') return 'West';
      if (v === 'central west' || v === 'centralwest') return 'Central West';
      if (v === 'central') return 'Central';
      if (v === 'central east' || v === 'centraleast') return 'Central East';
      if (v === 'east') return 'East';
      return null;
    }

    async function loadTrailsFromCSV() {
      try {
        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();
        const rows = parseCSV(text);

        // Map headers
        // Accept "Trail" or "Name" as trail name column
        rows.forEach(row => {
          const trailName = row['trail'] || row['name'] || '';
          const regionRaw = row['region'] || row['area'] || '';
          const region = normalizeRegionName(regionRaw);
          if (trailName && region && TRAILS_BY_REGION[region]) {
            TRAILS_BY_REGION[region].push(trailName);
          }
        });

        // Sort lists alphabetically
        Object.keys(TRAILS_BY_REGION).forEach(k => {
          TRAILS_BY_REGION[k].sort((a,b) => a.localeCompare(b));
        });

        bindPopups();
      } catch (e) {
        console.warn('Trails CSV not loaded — using fallback (empty).', e);
        bindPopups();
      }
    }

    function renderTrailListHTML(regionLabel) {
      const list = TRAILS_BY_REGION[regionLabel] || [];
      const items = list.map(t => `<li>${escapeHTML(t)}</li>`).join('');
      const emptyNote = list.length ? '' : `<em>No trails loaded yet. Ensure <code>${CSV_URL}</code> is present with Trail & Region columns.</em>`;
      return `
        <div class="popup-wrap">
          <h4>${regionLabel} — Trails</h4>
          ${list.length ? `<ol class="trail-list">${items}</ol>` : emptyNote}
        </div>
      `;
    }

    function escapeHTML(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function bindPopups() {
      // Attach popups with trail lists to each region band
      const mapKeyToLabel = {
        west: 'West',
        centralwest: 'Central West',
        central: 'Central',
        centraleast: 'Central East',
        east: 'East'
      };
      Object.keys(regions).forEach(key => {
        const label = mapKeyToLabel[key];
        const html = renderTrailListHTML(label);
        regions[key].bindPopup(html, { maxWidth: 360, closeButton: true });
      });
    }

    loadTrailsFromCSV();
  </script>
</body>
</html>
