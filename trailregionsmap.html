<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Columbia River Gorge — Region Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{
      height:100%;width:100%;margin:0;padding:0;
      font-family:Montserrat,sans-serif;color:#333;font-size:13px;
      border:none;
    }
    .container{
      display:flex;
      width:100%;
      height:100%;
      gap:0;
      border:none;
      margin:0;
      padding:0;
    }
    .map-column{
      flex:1;
      position:relative;
      box-sizing:border-box;
      border:1px solid #ddd;
      margin:0;
      padding:0;
    }
    #map{
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      border:none;
    }
    .legend-column{
      width:380px;
      background:#fff;
      padding:0 14px 14px 14px;
      overflow-y:auto;
      line-height:1.45;
      box-sizing:border-box;
      border:none;
      margin:0;
    }
    .legend-column h3{margin:-3px 0 16px 0;font-family:Montserrat,sans-serif;font-style:normal;font-weight:300;font-size:32px;line-height:1;color:#2e2e2e;padding:0;display:block;}
    .region-entry{margin:12px 0 8px 0;padding-bottom:12px;border-bottom:1px solid #ddd;}
    .region-entry:last-child{border-bottom:none;}
    .region-link{
      text-decoration:none;font-weight:700;font-size:18px;
      display:inline-block;margin-bottom:0;cursor:pointer;
    }
    .region-link:hover{opacity:0.75;}
    .region-meta{margin:4px 0 0 2px;color:#555;}
    .region-meta div{margin:0 0 4px 0;}
    .region-meta div:last-child{margin-bottom:0;}
    .legend-detail .back-row{position:sticky;top:0;background:#fff;padding:0 0 28.5px 0;z-index:2;margin-bottom:0;}
    .legend-detail .back-link{color:#06c;text-decoration:none;font-weight:600;cursor:pointer;}
    .legend-detail .back-link:hover{text-decoration:underline;}
    .legend-detail h3{font-size:18px;font-weight:700;margin:0 0 5.5px 0;line-height:1.2;}
    .legend-detail .region-info{color:#555;margin-bottom:8px;margin-left:2px;}
    .legend-detail .region-info div{margin:0 0 4px 0;line-height:1.5;}
    .legend-detail .region-info div:last-child{margin-bottom:0;}
    .trail-item{
      margin:12px 0;
      padding:10px;
      background:#f9f9f9;
      border-left:3px solid #ddd;
      border-radius:2px;
    }
    .trail-name{
      font-weight:700;
      font-size:15px;
      color:#2e2e2e;
      margin-bottom:4px;
    }
    .trail-meta{
      display:flex;
      gap:12px;
      margin-bottom:6px;
      font-size:12px;
      color:#666;
    }
    .trail-distance{font-weight:600;}
    .trail-rating{
      display:flex;
      gap:8px;
      font-size:12px;
    }
    .difficulty-badge, .popularity-badge{
      padding:2px 6px;
      border-radius:3px;
      font-weight:600;
    }
    .difficulty-badge{background:#e3f2fd;color:#1976d2;}
    .popularity-badge{background:#fff3e0;color:#f57c00;}
    .trail-description{
      font-size:13px;
      line-height:1.5;
      color:#555;
      margin-top:6px;
    }
    .error-message{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#fff;
      padding:20px;
      border:2px solid #ef4444;
      border-radius:8px;
      text-align:center;
      z-index:9999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-column">
      <div id="map"></div>
    </div>
    <div class="legend-column" id="legend"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    (function() {
      'use strict';
      
      // Constants
      var REGION_BASE_HALF = 0.045;
      var FADE_EXTENSION_LAT = 0.03;
      var FADE_STEPS = 5;
      var BORDER_STEPS = 10;
      var BORDER_COLOR = '#666';
      var WEST_CENTRAL_ZOOM = 11.5;
      
      var gorge = {};
      var eventListenersInitialized = false;
      
      gorge.DEFAULT_CENTER = [45.670, -121.800];
      gorge.DEFAULT_ZOOM = 9.6;

      gorge.REGION_INFO = {
        west:{label:'West',color:'#1B5E20',area:'Portland metro → Bridal Veil',mm:'17–28',
          highlights:'Waterfalls and short scenic hikes; historic Columbia River Highway viewpoints; lush mossy forests; easy access from Portland; family-friendly trails like Latourell and Bridal Veil Falls.'},
        centralwest:{label:'Central West',color:'#2E7D32',area:'Bridal Veil → Elowah Falls',mm:'28–40',
          highlights:'Iconic waterfall corridor (Multnomah, Wahkeena, Horsetail); steep canyon hikes with sweeping vistas; Benson Bridge photo stops; Gorge Trail 400 connections; picnic areas and visitor centers.'},
        central:{label:'Central',color:'#558B2F',area:'Bonneville Dam → Dog Mountain',mm:'40–51',
          highlights:'Forest climbs and summit routes (Hamilton Mountain, Table Mountain, Dog Mountain); panoramic viewpoints; Pacific Crest Trail crossings; Bridge of the Gods; Beacon Rock; spring wildflowers.'},
        centraleast:{label:'Central East',color:'#9E9D24',area:'Herman Creek → Hood River',mm:'51–64',
          highlights:'Steep basalt cliffs and open hillsides; scenic drives with river overlooks; lesser-traveled trails like Wyeth and Mitchell Point; spring wildflowers; transition zone between rainforest and grassland.'},
        east:{label:'East',color:'#C0CA33',area:'Mosier → The Dalles',mm:'64–90',
          highlights:'Drier climate with high-desert scenery; oak woodlands and wide-open ridges; wildflower plateaus; biking and wine-tasting routes near Rowena and Mosier; sunny weather and sweeping Gorge views.'}
      };

      gorge.TRAILS = {"Central West":[{"name":"Aldrich Butte","distance":"4 rt","description":"Hike to former WWII aircraft warning station with views of the Gorge. Parking area. $10 fee at Bonneville Hot Springs.","difficulty":2,"popularity":2},{"name":"Augspurger Mountain Trail","distance":"12.5 rt","description":"Difficult climb to wildflower meadows and ridge views; shares trailhead with Dog Mountain. Parking lot, vault toilets.","difficulty":5,"popularity":2},{"name":"Beacon Rock Trail","distance":"1.8 rt","description":"Switchbacking path to a dramatic overlook on a 848-foot monolith. Parking lot, flush toilets.","difficulty":2,"popularity":5},{"name":"Bell Creek Trail","distance":"3.4 rt","description":"Peaceful forest walk to a small waterfall at Bell Creek. Limited roadside parking.","difficulty":1,"popularity":1},{"name":"Benson Plateau","distance":"15.5 lp","description":"Challenging loop through old-growth forest to a remote, lake-dotted plateau. Parking area, vault toilets.","difficulty":5,"popularity":2},{"name":"Dog Mountain","distance":"7.8 rt","description":"Steep climb to legendary wildflower displays and 360-degree Gorge views. Parking lot, vault toilets.","difficulty":4,"popularity":5},{"name":"Dry Creek Falls","distance":"2.6 rt","description":"Short, family-friendly walk to a 75-foot falls in a lush canyon. Roadside parking.","difficulty":1,"popularity":3},{"name":"Eagle Creek Trail","distance":"12 rt","description":"Iconic riverside trail along Eagle Creek with waterfalls, tunnels, and cliffs. Parking lot, vault toilets.","difficulty":3,"popularity":5},{"name":"Elowah Falls","distance":"1.6 rt","description":"Easy hike to a stunning 289-foot waterfall. Parking lot.","difficulty":1,"popularity":4},{"name":"Falls Creek Falls","distance":"6.5 rt","description":"Moderate hike through forest to a 60-foot waterfall near the Washington side. Parking area.","difficulty":2,"popularity":3},{"name":"Fort Cascades Loop","distance":"1.2 rt","description":"Historical walk exploring remnants of a mid-1800s military fort. Parking lot.","difficulty":1,"popularity":2},{"name":"Hamilton Mountain Loop","distance":"7.8 lp","description":"Popular loop to summit viewpoint via waterfalls and wildflower slopes. Parking lot, vault toilets.","difficulty":4,"popularity":4},{"name":"Hardy Ridge Loop","distance":"9.9 lp","description":"Challenging ridge hike with views over the Gorge and Cascade peaks. Parking area.","difficulty":4,"popularity":2},{"name":"Heartbreak Ridge","distance":"14 rt","description":"Arduous climb to a remote ridge with Gorge and mountain vistas. Parking area, vault toilets.","difficulty":5,"popularity":1},{"name":"Herman Creek Pinnacles","distance":"6.2 rt","description":"Steep ascent to rocky pinnacle with commanding views. Parking area, vault toilets.","difficulty":4,"popularity":2},{"name":"Horsetail Falls Loop","distance":"2.8 lp","description":"Family-friendly loop passing Horsetail and Ponytail Falls. Roadside parking.","difficulty":2,"popularity":5},{"name":"Indian Point Loop","distance":"2.9 lp","description":"Short loop with Gorge views and wildflowers in spring. Parking area.","difficulty":2,"popularity":2},{"name":"John B. Yeon Trailhead","distance":"varies","description":"Access point for trails including Elowah Falls and Nesmith Point. Parking lot.","difficulty":2,"popularity":3},{"name":"Multnomah Falls","distance":"0.5 rt","description":"World-famous 620-foot waterfall; paved trail to Benson Bridge. Large parking lot, visitor center, flush toilets.","difficulty":1,"popularity":5},{"name":"Multnomah–Wahkeena Loop","distance":"5.4 lp","description":"Classic waterfall loop via Multnomah and Wahkeena Falls. Parking lot, visitor center, flush toilets.","difficulty":3,"popularity":5},{"name":"Munra Point","distance":"5.4 rt","description":"Difficult scramble to a rocky summit with sweeping views. Roadside parking.","difficulty":5,"popularity":3},{"name":"Nesmith Point Trail","distance":"9.8 rt","description":"Strenuous climb to a forested summit with Gorge views. Parking lot, vault toilets.","difficulty":5,"popularity":2},{"name":"Nick Eaton Ridge Loop","distance":"13.7 lp","description":"Challenging ridge loop with meadows and viewpoints. Parking area, vault toilets.","difficulty":5,"popularity":2},{"name":"Oneonta Gorge","distance":"0.6 rt","description":"Unique gorge wade to a hidden waterfall (summer only). Roadside parking.","difficulty":2,"popularity":5},{"name":"Ponytail Falls Trail","distance":"0.8 rt","description":"Short walk to Ponytail Falls; trail goes behind the falls. Roadside parking.","difficulty":1,"popularity":5},{"name":"Pool Of The Winds","distance":"4.5 rt","description":"Hike to a grotto behind Punchbowl Falls. Parking area, vault toilets.","difficulty":2,"popularity":3},{"name":"Punchbowl Falls","distance":"4.2 rt","description":"Walk along Eagle Creek to a spectacular amphitheater waterfall. Parking lot, vault toilets.","difficulty":2,"popularity":5},{"name":"Ruckel Ridge Loop","distance":"9.5 lp","description":"Extremely challenging loop with steep climbs and exposed ridges. Parking lot.","difficulty":5,"popularity":3},{"name":"Strawberry Island","distance":"1.5 rt","description":"Easy riverside trail with beach access and wildlife viewing. Parking lot.","difficulty":1,"popularity":3},{"name":"Table Mountain Loop","distance":"15.6 lp","description":"Long, demanding summit loop with wildflowers and Gorge views. Parking lot, vault toilets.","difficulty":5,"popularity":3},{"name":"Tamanous Trail","distance":"8 rt","description":"Moderately difficult forest hike with ridge views. Parking area, vault toilets.","difficulty":3,"popularity":2},{"name":"Tanner Butte Trail","distance":"17.2 rt","description":"Long, rugged trek to a forested summit. Parking area, vault toilets.","difficulty":5,"popularity":1},{"name":"Tanner Ridge","distance":"10.2 rt","description":"Steady climb to a viewpoint on Tanner Ridge. Parking area, vault toilets.","difficulty":4,"popularity":2},{"name":"Tom McCall Point","distance":"3.2 rt","description":"Popular wildflower hike to a grassy viewpoint. Parking area.","difficulty":2,"popularity":5},{"name":"Triple Falls Trail","distance":"5 rt","description":"Moderate forest walk to a three-tiered waterfall. Parking lot, vault toilets.","difficulty":2,"popularity":4},{"name":"Tunnel Falls","distance":"12 rt","description":"Extended hike along Eagle Creek to a waterfall with a trail tunnel behind it. Parking lot, vault toilets.","difficulty":3,"popularity":4},{"name":"Upper McCord Creek Falls","distance":"4.8 rt","description":"Steep climb to a 100-foot waterfall in a hidden canyon. Parking lot.","difficulty":3,"popularity":2},{"name":"Wahclella Falls","distance":"2 rt","description":"Easy, family-friendly hike to a 350-foot waterfall. Parking lot, vault toilets.","difficulty":1,"popularity":5},{"name":"Wahkeena Falls","distance":"0.4 rt","description":"Very short paved walk to a stunning 242-foot waterfall. Parking lot, vault toilets.","difficulty":1,"popularity":5},{"name":"Wauna Point","distance":"6.4 rt","description":"Moderate climb to a viewpoint overlooking the Gorge. Parking lot, vault toilets.","difficulty":3,"popularity":2},{"name":"Wauna Viewpoint","distance":"6.8 rt","description":"Hike to viewpoint with Gorge and waterfall vistas. Parking lot, vault toilets.","difficulty":3,"popularity":2}],"West":[{"name":"Angels' Rest","distance":"4.8 rt","description":"Iconic cliff-edge viewpoint above the western Gorge; mostly forested climb. Parking lot, vault toilets.","difficulty":3,"popularity":5},{"name":"Angels' Rest to Devil's Rest","distance":"10 rt","description":"Extended loop combining two popular viewpoints with Coopey Falls. Parking lot, flush toilets.","difficulty":4,"popularity":3},{"name":"Bridal Veil Falls","distance":"0.6 rt","description":"Short, paved walk to a two-tiered waterfall. Parking lot, flush toilets.","difficulty":1,"popularity":5},{"name":"Bridal Veil Loop","distance":"0.8 lp","description":"Easy interpretive loop through old-growth forest near Bridal Veil Falls. Parking lot, flush toilets.","difficulty":1,"popularity":4},{"name":"Cape Horn Loop Trail","distance":"7.2 lp","description":"Scenic loop with Columbia River views and spring wildflowers. Parking lot, vault toilets.","difficulty":3,"popularity":4},{"name":"Coopey Falls","distance":"1 rt","description":"Short side trail to a secluded waterfall on the Angels Rest route. Parking lot, flush toilets.","difficulty":1,"popularity":2},{"name":"Devils Rest","distance":"8.6 rt","description":"Steady climb to a forested summit viewpoint. Parking lot, flush toilets.","difficulty":4,"popularity":2},{"name":"Fairy Falls","distance":"6.8 rt","description":"Moderate hike to a cascading waterfall in a peaceful canyon. Parking area.","difficulty":3,"popularity":2},{"name":"Franklin Ridge","distance":"7.4 rt","description":"Ridge hike with views of the western Gorge. Parking area.","difficulty":3,"popularity":1},{"name":"Gorge Trail #400","distance":"varies","description":"Historic long-distance trail connecting many waterfalls and viewpoints. Multiple access points.","difficulty":3,"popularity":4},{"name":"Larch Mt via Multnomah Falls","distance":"13.6 rt","description":"Challenging climb from Multnomah Falls to Larch Mountain summit. Parking lot, visitor center, flush toilets.","difficulty":5,"popularity":3},{"name":"Latourell Falls Trail","distance":"2.4 lp","description":"Easy loop to a 249-foot waterfall; includes upper and lower falls. Parking lot, vault toilets.","difficulty":1,"popularity":5},{"name":"Rooster Rock Loop","distance":"1.5 lp","description":"Easy riverside walk with beach and bird-watching. Large parking lot, flush toilets.","difficulty":1,"popularity":3},{"name":"Sandy River Delta","distance":"varies","description":"Flat, easy trails through wetlands and along the Sandy River. Parking lot.","difficulty":1,"popularity":3},{"name":"Shepperd's Dell","distance":"0.3 rt","description":"Very short walk to a hidden waterfall and stone bridge. Roadside parking.","difficulty":1,"popularity":4},{"name":"Washougal Waterfront Trail","distance":"2 rt","description":"Paved riverside trail with picnic areas and river access. Parking lot, flush toilets.","difficulty":1,"popularity":2}],"Central East":[{"name":"Cabin Creek Falls","distance":"2.6 rt","description":"Easy hike to a 100-foot waterfall on Cabin Creek. Parking area.","difficulty":1,"popularity":2},{"name":"Chetwoot Loop Hike","distance":"6.6 lp","description":"Loop through oak woodlands with Gorge views. Parking area.","difficulty":2,"popularity":2},{"name":"Hole-in-the-Wall Falls","distance":"1.6 rt","description":"Short walk to a scenic waterfall that flows through a rock tunnel. Parking area.","difficulty":1,"popularity":3},{"name":"Lancaster Falls","distance":"2 rt","description":"Moderate hike to a 30-foot waterfall. Parking area.","difficulty":2,"popularity":2},{"name":"Lower Starvation Loop","distance":"3.4 lp","description":"Easy loop with waterfalls and forest scenery. Parking area.","difficulty":1,"popularity":3},{"name":"Mark O. Hatfield Trailhead","distance":"varies","description":"Pacific Crest Trail access with connections to multiple routes. Parking area.","difficulty":3,"popularity":3},{"name":"Memaloose Hills","distance":"6 rt","description":"Moderate climb to viewpoints over the Columbia River. Parking area.","difficulty":3,"popularity":2},{"name":"Mitchell Point Trail","distance":"4.8 rt","description":"Challenging climb to a historic viewpoint site. Parking area.","difficulty":4,"popularity":3},{"name":"Mosier Creek Falls","distance":"1.6 rt","description":"Easy walk to a small waterfall on Mosier Creek. Parking area.","difficulty":1,"popularity":2},{"name":"Mosier Plateau","distance":"3.4 rt","description":"Wildflower trail with panoramic Gorge views. Parking area.","difficulty":2,"popularity":4},{"name":"Mosier Twin Tunnels","distance":"4.5 rt","description":"Paved trail through historic tunnels with river views. Parking lot, vault toilets.","difficulty":1,"popularity":5},{"name":"Mt. Defiance Loop","distance":"11.8 lp","description":"Extremely strenuous climb to the highest point in the Gorge. Parking area, vault toilets.","difficulty":5,"popularity":3},{"name":"North Lake","distance":"9.6 rt","description":"Long hike to a remote alpine lake with forest and mountain views. Parking area, vault toilets.","difficulty":4,"popularity":2},{"name":"Rowena Plateau","distance":"2.2 rt","description":"Easy wildflower trail with sweeping Gorge views. Parking area, vault toilets.","difficulty":1,"popularity":5},{"name":"Starvation Creek Trail","distance":"1.8 rt","description":"Short trail to Starvation Creek Falls. Parking area.","difficulty":1,"popularity":3},{"name":"Starvation Ridge","distance":"10.4 rt","description":"Difficult ridge hike with expansive viewpoints. Parking area.","difficulty":5,"popularity":2},{"name":"Tooth Rock Loop","distance":"4.8 lp","description":"Moderate loop with views of Tooth Rock and the Gorge. Parking area.","difficulty":2,"popularity":3},{"name":"Wahtum Lake","distance":"14 rt","description":"Long forest hike to a scenic mountain lake. Parking area, vault toilets.","difficulty":4,"popularity":3},{"name":"Wyeth Trail","distance":"10 rt","description":"Steady climb along Wyeth Creek with waterfalls. Parking area, vault toilets.","difficulty":3,"popularity":2},{"name":"Wygant Peak","distance":"8.6 rt","description":"Challenging climb to a summit with panoramic Gorge views. Parking area.","difficulty":4,"popularity":3}],"Central":[{"name":"Bonneville Dam Trail","distance":"2 rt","description":"Easy interpretive trail along the Columbia River near the dam. Parking lot, flush toilets.","difficulty":1,"popularity":3},{"name":"Bridge Of The Gods Trailhead","distance":"varies","description":"Pacific Crest Trail access near Bridge of the Gods. Parking lot.","difficulty":2,"popularity":3},{"name":"Cascade Locks Trail","distance":"2.5 rt","description":"Historic riverside trail with views of locks and dam. Parking lot, flush toilets.","difficulty":1,"popularity":2}],"East":[{"name":"Balfour-Klickitat Loop","distance":"10.8 lp","description":"Challenging loop through grasslands and oak forests. Parking area.","difficulty":4,"popularity":2},{"name":"Catherine Creek Arch Loop","distance":"3.8 lp","description":"Loop to a natural rock arch with wildflowers and views. Parking area, vault toilets.","difficulty":2,"popularity":5},{"name":"Columbia Hills State Park","distance":"varies","description":"Multiple trails through open grasslands and oak woodlands. Parking area.","difficulty":2,"popularity":3},{"name":"Coyote Wall","distance":"6.6 rt","description":"Wildflower-covered hillside with commanding Gorge views. Parking area.","difficulty":3,"popularity":5},{"name":"Crawford Oaks","distance":"3.6 rt","description":"Easy walk through ancient oak groves with spring wildflowers. Parking area.","difficulty":1,"popularity":3},{"name":"Deschutes River Trail","distance":"varies","description":"Riverside trail along the scenic Deschutes River. Parking area.","difficulty":1,"popularity":4},{"name":"Gillette Lake","distance":"2.8 lp","description":"Easy loop around a serene forest lake. Parking area.","difficulty":1,"popularity":2},{"name":"Labyrinth / Syncline","distance":"6 lp","description":"Loop through dramatic rock formations and wildflower meadows. Parking area.","difficulty":3,"popularity":4},{"name":"Lyle Cherry Orchard","distance":"4.2 rt","description":"Spring wildflower hike through old cherry orchards. Parking area.","difficulty":2,"popularity":4},{"name":"Steigerwald Lake Trail","distance":"3.6 lp","description":"Easy wetland loop with bird-watching and lake views. Parking lot, flush toilets.","difficulty":1,"popularity":3}]};

      gorge.REGION_CENTER_LAT = {
        west:45.55,
        centralwest:45.60,
        central:45.690,
        centraleast:45.705,
        east:45.68
      };

      gorge.slices = {
        west:{minLon:-122.50,maxLon:-122.17},
        centralwest:{minLon:-122.17,maxLon:-121.91},
        central:{minLon:-121.91,maxLon:-121.60},
        centraleast:{minLon:-121.60,maxLon:-121.38},
        east:{minLon:-121.38,maxLon:-121.10}
      };

      gorge.regions = {};
      gorge.baseCoords = {};
      gorge.regionLayers = {};
      gorge.regionLabels = {};
      
      function showError(message) {
        var errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = '<h3>Map Error</h3><p>' + message + '</p>';
        document.getElementById('map').appendChild(errorDiv);
      }
      
      function initGorge() {
        try {
          if (typeof L === 'undefined') {
            throw new Error('Leaflet library failed to load');
          }
          
          gorge.map = L.map('map').setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);

          L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
            { attribution: '&copy; Esri, USGS, NOAA, U.S. Navy, NGA, GEBCO' }
          ).addTo(gorge.map);

          gorge.legend = document.getElementById('legend');
          
          createRegions();
          setupEventListeners();
          renderGuide();
        } catch (e) {
          console.error('Initialization error:', e);
          showError('Failed to load map: ' + e.message);
        }
      }

      function rectCoordsFor(key, minLon, maxLon, half) {
        var c = gorge.REGION_CENTER_LAT[key];
        return [[c+half,minLon],[c+half,maxLon],[c-half,maxLon],[c-half,minLon]];
      }
      
      function createRegionLayers(k, i, s) {
        var centerLat = gorge.REGION_CENTER_LAT[k];
        var layers = [];
        
        for(var step = 1; step <= FADE_STEPS; step++) {
          var topStart = centerLat + REGION_BASE_HALF + (FADE_EXTENSION_LAT * (step - 1));
          var topEnd = centerLat + REGION_BASE_HALF + (FADE_EXTENSION_LAT * step);
          var opacity = 0.35 - (0.35 * (step / FADE_STEPS));
          
          var layer = L.polygon([
            [topEnd, s.minLon],
            [topEnd, s.maxLon],
            [topStart, s.maxLon],
            [topStart, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          layers.push(layer);
        }
        
        for(var step = 1; step <= FADE_STEPS; step++) {
          var bottomStart = centerLat - REGION_BASE_HALF - (FADE_EXTENSION_LAT * (step - 1));
          var bottomEnd = centerLat - REGION_BASE_HALF - (FADE_EXTENSION_LAT * step);
          var opacity = 0.35 - (0.35 * (step / FADE_STEPS));
          
          var layer = L.polygon([
            [bottomStart, s.minLon],
            [bottomStart, s.maxLon],
            [bottomEnd, s.maxLon],
            [bottomEnd, s.minLon]
          ], {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: opacity,
            interactive: false
          }).addTo(gorge.map);
          layers.push(layer);
        }
        
        var totalHeight = REGION_BASE_HALF * 2 + (FADE_EXTENSION_LAT * FADE_STEPS * 2);
        var startLat = centerLat - REGION_BASE_HALF - (FADE_EXTENSION_LAT * FADE_STEPS);
        
        for(var bstep = 0; bstep < BORDER_STEPS; bstep++) {
          var latStart = startLat + (totalHeight * bstep / BORDER_STEPS);
          var latEnd = startLat + (totalHeight * (bstep + 1) / BORDER_STEPS);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = REGION_BASE_HALF + (FADE_EXTENSION_LAT * FADE_STEPS);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
            color: BORDER_COLOR,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          layers.push(layer);
        }
        
        for(var bstep = 0; bstep < BORDER_STEPS; bstep++) {
          var latStart = startLat + (totalHeight * bstep / BORDER_STEPS);
          var latEnd = startLat + (totalHeight * (bstep + 1) / BORDER_STEPS);
          var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
          var maxDist = REGION_BASE_HALF + (FADE_EXTENSION_LAT * FADE_STEPS);
          var borderOpacity = 1 - (distFromCenter / maxDist);
          borderOpacity = Math.max(0, Math.min(1, borderOpacity));
          
          var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
            color: BORDER_COLOR,
            weight: 2,
            opacity: borderOpacity
          }).addTo(gorge.map);
          layers.push(layer);
        }
        
        return layers;
      }

      function createRegions() {
        for(var k in gorge.slices) {
          var i = gorge.REGION_INFO[k];
          var s = gorge.slices[k];
          var coords = rectCoordsFor(k, s.minLon, s.maxLon, REGION_BASE_HALF);
          gorge.baseCoords[k] = coords.slice();
          
          gorge.regionLayers[k] = createRegionLayers(k, i, s);
          
          gorge.regions[k] = L.polygon(coords, {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: 0.35
          }).addTo(gorge.map);
          
          var centerLat = gorge.REGION_CENTER_LAT[k];
          var labelIcon = L.divIcon({
            className: 'region-label',
            html: '<div style="font-size:16px;font-weight:700;color:'+i.color+';text-shadow:1px 1px 2px rgba(255,255,255,0.9), -1px -1px 2px rgba(255,255,255,0.9), 1px -1px 2px rgba(255,255,255,0.9), -1px 1px 2px rgba(255,255,255,0.9);white-space:nowrap;text-align:center;">'+i.label+'</div>',
            iconSize: [100, 0],
            iconAnchor: [50, 0]
          });
          
          gorge.regionLabels[k] = L.marker([centerLat, (s.minLon + s.maxLon) / 2], {
            icon: labelIcon,
            interactive: false
          }).addTo(gorge.map);
        }
      }
    
      function resetBands() {
        for(var k in gorge.regions) {
          for(var j = 0; j < gorge.regionLayers[k].length; j++) {
            if(gorge.map.hasLayer(gorge.regionLayers[k][j])) {
              gorge.map.removeLayer(gorge.regionLayers[k][j]);
            }
          }
          
          var i = gorge.REGION_INFO[k];
          var s = gorge.slices[k];
          gorge.regionLayers[k] = createRegionLayers(k, i, s);
          
          gorge.regions[k].setLatLngs(gorge.baseCoords[k]);
          gorge.regions[k].setStyle({fillOpacity: 0.35});
        }
      }

      function escapeHTML(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      
      function getDifficultyLabel(d) {
        var labels = ['', 'Easy', 'Moderate', 'Moderate+', 'Hard', 'Very Hard'];
        return labels[d] || 'Unknown';
      }
      
      function getPopularityLabel(p) {
        var labels = ['', 'Hidden Gem', 'Quiet', 'Moderate', 'Busy', 'Very Busy'];
        return labels[p] || 'Unknown';
      }

      function renderGuide(resetView) {
        gorge.legend.className = 'legend-column';
        var html = '<h3>Region Guide</h3>';
        for(var k in gorge.REGION_INFO) {
          var i = gorge.REGION_INFO[k];
          var trailCount = (gorge.TRAILS[i.label] || []).length;
          html += '<div class="region-entry"><a class="region-link" style="color:'+i.color+';" data-region="'+k+'">'+i.label+'</a><div class="region-meta"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div><div><strong>Trails:</strong> '+trailCount+'</div></div></div>';
        }
        gorge.legend.innerHTML = html;
        
        var links = gorge.legend.querySelectorAll('.region-link');
        for(var i=0; i<links.length; i++) {
          links[i].onclick = function() {
            showRegion(this.getAttribute('data-region'));
          };
        }
        
        if(resetView) {
          gorge.map.setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);
        }
      }

      function renderRegionDetail(k) {
        var i = gorge.REGION_INFO[k];
        var trails = (gorge.TRAILS[i.label] || []).slice().sort(function(a,b){return a.name.localeCompare(b.name);});
        gorge.legend.className = 'legend-column legend-detail';
        var html = '<div class="back-row"><a class="back-link" id="backLink">← Back to Region Guide</a></div><h3 style="color:'+i.color+';">'+i.label+'</h3><div class="region-info"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div><div><strong>Highlights:</strong> '+i.highlights+'</div><div><strong>Trails:</strong> '+trails.length+'</div></div>';
        
        for(var j=0; j<trails.length; j++) {
          var t = trails[j];
          html += '<div class="trail-item">';
          html += '<div class="trail-name">'+escapeHTML(t.name)+'</div>';
          html += '<div class="trail-meta">';
          html += '<span class="trail-distance">'+escapeHTML(t.distance)+'</span>';
          html += '<span class="trail-rating">';
          html += '<span class="difficulty-badge">'+getDifficultyLabel(t.difficulty)+'</span>';
          html += '<span class="popularity-badge">'+getPopularityLabel(t.popularity)+'</span>';
          html += '</span>';
          html += '</div>';
          html += '<div class="trail-description">'+escapeHTML(t.description)+'</div>';
          html += '</div>';
        }
        
        gorge.legend.innerHTML = html;
        
        document.getElementById('backLink').onclick = function() {
          backToGuide();
        };
      }

      function showRegion(k) {
        for(var rk in gorge.regions) {
          if(gorge.map.hasLayer(gorge.regions[rk])) {
            gorge.map.removeLayer(gorge.regions[rk]);
          }
          if(gorge.map.hasLayer(gorge.regionLabels[rk])) {
            gorge.map.removeLayer(gorge.regionLabels[rk]);
          }
          if(gorge.regionLayers[rk]) {
            for(var j = 0; j < gorge.regionLayers[rk].length; j++) {
              if(gorge.map.hasLayer(gorge.regionLayers[rk][j])) {
                gorge.map.removeLayer(gorge.regionLayers[rk][j]);
              }
            }
          }
        }
        
        var i = gorge.REGION_INFO[k];
        var s = gorge.slices[k];
        var count = (gorge.TRAILS[i.label] || []).length;
        var half = REGION_BASE_HALF + Math.min(0.12, (count/6)*0.002);
        var centerLat = gorge.REGION_CENTER_LAT[k];
        
        if(!gorge.expandedLayers) gorge.expandedLayers = {};
        if(gorge.expandedLayers[k]) {
          for(var j = 0; j < gorge.expandedLayers[k].length; j++) {
            if(gorge.map.hasLayer(gorge.expandedLayers[k][j])) {
              gorge.map.removeLayer(gorge.expandedLayers[k][j]);
            }
          }
        }
        gorge.expandedLayers[k] = [];
        
        var lines = [
          [[centerLat + half, s.minLon], [centerLat + half, s.maxLon]],
          [[centerLat - half, s.minLon], [centerLat - half, s.maxLon]],
          [[centerLat + half, s.minLon], [centerLat - half, s.minLon]],
          [[centerLat + half, s.maxLon], [centerLat - half, s.maxLon]]
        ];
        
        for(var b = 0; b < lines.length; b++) {
          var line = L.polyline(lines[b], {
            color: i.color,
            weight: 3,
            opacity: 0.8
          }).addTo(gorge.map);
          gorge.expandedLayers[k].push(line);
        }
        
        renderRegionDetail(k);
        
        var bounds = [
          [centerLat + half, s.minLon],
          [centerLat - half, s.maxLon]
        ];
        
        if(k === 'west' || k === 'central') {
          var centerLng = (s.minLon + s.maxLon) / 2;
          gorge.map.setView([centerLat, centerLng], WEST_CENTRAL_ZOOM);
        } else {
          gorge.map.fitBounds(bounds, {padding: [20, 20]});
        }
      }
      
      function backToGuide() {
        if(gorge.expandedLayers) {
          for(var k in gorge.expandedLayers) {
            for(var j = 0; j < gorge.expandedLayers[k].length; j++) {
              if(gorge.map.hasLayer(gorge.expandedLayers[k][j])) {
                gorge.map.removeLayer(gorge.expandedLayers[k][j]);
              }
            }
          }
        }
        
        for(var k in gorge.regions) {
          if(!gorge.map.hasLayer(gorge.regions[k])) {
            gorge.map.addLayer(gorge.regions[k]);
            gorge.map.addLayer(gorge.regionLabels[k]);
          }
        }
        
        resetBands();
        renderGuide(true);
      }

      function setupEventListeners() {
        gorge.map.on('click', function() {
          backToGuide();
        });
        
        for(var k in gorge.regions) {
          (function(key) {
            gorge.regions[key].on('click', function(e) {
              L.DomEvent.stopPropagation(e);
              showRegion(key);
            });
          })(k);
        }
        
        if (!eventListenersInitialized) {
          document.addEventListener('keydown', function(e) {
            if(e.key === 'Escape' || e.keyCode === 27) {
              backToGuide();
            }
          });
          eventListenersInitialized = true;
        }
      }

      var leafletScript = document.querySelector('script[src*="leaflet"]');
      if (leafletScript) {
        leafletScript.addEventListener('load', function() {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGorge);
          } else {
            initGorge();
          }
        });
        if (typeof L !== 'undefined') {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGorge);
          } else {
            initGorge();
          }
        }
      } else {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initGorge);
        } else {
          initGorge();
        }
      }
    })();
  </script>
</body>
</html>
