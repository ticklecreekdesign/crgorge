<!-- MAP WRAPPER (Hostinger needs an explicit height) -->
<div id="crg-map-wrap" style="width:100%; max-width:1400px; margin:0 auto;">
  <div id="map" style="width:100%; height:770px; border:1px solid #CCCCCC;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  /* optional: make the map shorter on mobile */
  @media (max-width: 768px){
    #map{ height:545px !important; }
  }

  .region-label-wrapper{
    background: transparent !important;
    border: none !important;
    transform: translate(-50%, -50%);
  }

  .region-label-text{
    color:#000;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    text-align:center;
    line-height:1.12;
    white-space:nowrap;
  }

  /* Keep these, but inline styles will enforce size */
  .region-label-text .mp{
    font-size:12px !important;
    font-weight:400 !important;
  }
  .region-label-text .name{
    font-size:12px !important;
    font-weight:400 !important;
    letter-spacing:0.8px;
  }

  /* Button under zoom controls */
  .leaflet-control-open-full a{
    width:34px;
    height:34px;
    line-height:34px;
    text-align:center;
    font-size:18px;
    display:block;
    text-decoration:none;
    color:#333;
    background:#fff;
  }
  .leaflet-control-open-full a:hover{ background:#f4f4f4; }
</style>

<script>
(function(){
  // If Hostinger re-renders blocks, prevent double-init
  if (window.__CRG_MAP_INIT__) return;
  window.__CRG_MAP_INIT__ = true;

  const params = new URLSearchParams(window.location.search);
  const unrestricted = params.get('unrestricted') === '1';
  const defaultZoom = 10;

  const map = L.map('map', {
    center: [45.62, -121.6],
    zoom: defaultZoom,
    minZoom: unrestricted ? 0 : defaultZoom,
    zoomControl: true,
    scrollWheelZoom: false,
    doubleClickZoom: false
  });

  // Force proper sizing once the embed block has laid out
  function fixSize(){ map.invalidateSize(true); }
  setTimeout(fixSize, 50);
  setTimeout(fixSize, 200);
  window.addEventListener('resize', () => setTimeout(fixSize, 100));

  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Tiles &copy; Esri', maxZoom: 19 }
  ).addTo(map);

  // Open unrestricted map in new window (no restrictions) preserving view
  if (!unrestricted) {
    const OpenFullControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-open-full');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#';
        link.title = 'Open full map in a new window';
        link.setAttribute('aria-label', 'Open full map in a new window');
        link.innerHTML = '⤢';

        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(link, 'click', (e) => {
          L.DomEvent.preventDefault(e);
          const c = map.getCenter();
          const z = map.getZoom();
          const url = new URL(window.location.href);
          url.searchParams.set('unrestricted', '1');
          url.searchParams.set('lat', c.lat.toFixed(6));
          url.searchParams.set('lng', c.lng.toFixed(6));
          url.searchParams.set('z', String(z));
          window.open(url.toString(), '_blank', 'noopener');
        });

        return container;
      }
    });
    new OpenFullControl().addTo(map);
  }

  const colors = {
    west: '#1B5E20',
    centralWest: '#2E7D32',
    central: '#558B2F',
    centralEast: '#9E9D24',
    east: '#C0CA33'
  };

  const OR = [
    [45.542793, -122.357188],
    [45.594439, -122.069067],
    [45.693033, -121.788757],
    [45.708906, -121.490056],
    [45.607299, -121.197596],
    [45.635525, -120.911525]
  ];

  const WA = [
    [45.57168228259249, -122.31767443196766],
    [45.59242347354461, -122.07760326175781],
    [45.61316466449673, -121.83753209154797],
    [45.63390585544885, -121.59746092133812],
    [45.65464704640097, -121.35738975112828],
    [45.67538823737303, -120.87730858090842]
  ];

  const regions = [
    { name: 'West',         orMp: '19–34',  waMp: '16–32',  color: colors.west,        leftOR: OR[0], rightOR: OR[1], leftWA: WA[0], rightWA: WA[1] },
    { name: 'Central West', orMp: '34–50',  waMp: '32–50',  color: colors.centralWest, leftOR: OR[1], rightOR: OR[2], leftWA: WA[1], rightWA: WA[2] },
    { name: 'Central',      orMp: '50–65',  waMp: '50–65',  color: colors.central,     leftOR: OR[2], rightOR: OR[3], leftWA: WA[2], rightWA: WA[3] },
    { name: 'Central East', orMp: '65–84',  waMp: '65–81',  color: colors.centralEast, leftOR: OR[3], rightOR: OR[4], leftWA: WA[3], rightWA: WA[4] },
    { name: 'East',         orMp: '84–100', waMp: '81–96',  color: colors.east,        leftOR: OR[4], rightOR: OR[5], leftWA: WA[4], rightWA: WA[5] }
  ];

  const fadeSteps = 15;
  const fadeExtension = 0.15;
  const baseOpacity = 0.35;

  const outline = `
    text-shadow:
      1px 1px 0 #fff,
     -1px 1px 0 #fff,
      1px -1px 0 #fff,
     -1px -1px 0 #fff,
      0  2px 0 #fff,
      0 -2px 0 #fff,
      2px 0  0 #fff,
     -2px 0  0 #fff;
  `;

  regions.forEach(region => {
    const leftLng = (region.leftOR[1] + region.leftWA[1]) / 2;
    const rightLng = (region.rightOR[1] + region.rightWA[1]) / 2;

    const northLat = Math.max(region.leftWA[0], region.rightWA[0], region.leftOR[0], region.rightOR[0]);
    const southLat = Math.min(region.leftWA[0], region.rightWA[0], region.leftOR[0], region.rightOR[0]);

    // main fill
    L.polygon([
      [southLat, leftLng],
      [southLat, rightLng],
      [northLat, rightLng],
      [northLat, leftLng]
    ], { color:'transparent', weight:0, fillColor:region.color, fillOpacity:baseOpacity }).addTo(map);

    // fade north
    for (let i = 1; i <= fadeSteps; i++) {
      const fadeStart = northLat + (fadeExtension / fadeSteps) * (i - 1);
      const fadeEnd = northLat + (fadeExtension / fadeSteps) * i;
      const opacity = baseOpacity * (1 - i / fadeSteps);

      L.polygon([[fadeStart,leftLng],[fadeStart,rightLng],[fadeEnd,rightLng],[fadeEnd,leftLng]],
        { color:'transparent', weight:0, fillColor:region.color, fillOpacity:opacity }).addTo(map);
    }

    // fade south
    for (let i = 1; i <= fadeSteps; i++) {
      const fadeStart = southLat - (fadeExtension / fadeSteps) * (i - 1);
      const fadeEnd = southLat - (fadeExtension / fadeSteps) * i;
      const opacity = baseOpacity * (1 - i / fadeSteps);

      L.polygon([[fadeStart,leftLng],[fadeStart,rightLng],[fadeEnd,rightLng],[fadeEnd,leftLng]],
        { color:'transparent', weight:0, fillColor:region.color, fillOpacity:opacity }).addTo(map);
    }

    // boundary lines
    const lineSteps = 20;
    const verticalExtent = 0.25;

    const leftCenterLat = (region.leftOR[0] + region.leftWA[0]) / 2;
    const rightCenterLat = (region.rightOR[0] + region.rightWA[0]) / 2;

    for (let i = 0; i < lineSteps; i++) {
      const t1 = i / lineSteps, t2 = (i + 1) / lineSteps;
      const lat1 = (leftCenterLat - verticalExtent) + t1 * (verticalExtent * 2);
      const lat2 = (leftCenterLat - verticalExtent) + t2 * (verticalExtent * 2);
      const avgDist = (Math.abs(lat1-leftCenterLat)+Math.abs(lat2-leftCenterLat))/2;
      const opacity = Math.max(0.1, 1 - (avgDist / verticalExtent) * 0.9);
      L.polyline([[lat1,leftLng],[lat2,leftLng]], { color:'#888', weight:2, opacity }).addTo(map);
    }

    for (let i = 0; i < lineSteps; i++) {
      const t1 = i / lineSteps, t2 = (i + 1) / lineSteps;
      const lat1 = (rightCenterLat - verticalExtent) + t1 * (verticalExtent * 2);
      const lat2 = (rightCenterLat - verticalExtent) + t2 * (verticalExtent * 2);
      const avgDist = (Math.abs(lat1-rightCenterLat)+Math.abs(lat2-rightCenterLat))/2;
      const opacity = Math.max(0.1, 1 - (avgDist / verticalExtent) * 0.9);
      L.polyline([[lat1,rightLng],[lat2,rightLng]], { color:'#888', weight:2, opacity }).addTo(map);
    }

    // label placement
    const centerLat = (leftCenterLat + rightCenterLat) / 2;
    const centerLng = (leftLng + rightLng) / 2;

    // ✅ Inline styles guarantee the font size changes apply
    const label = L.divIcon({
      className: 'region-label-wrapper',
      html: `
        <div class="region-label-text" style="text-align:center; line-height:1.12; white-space:nowrap; color:#000;">
          <div class="mp" style="font-size:12px; font-weight:400;">WA ${region.waMp}</div>
          <div class="name" style="font-size:12px; font-weight:400; letter-spacing:0.8px; ${outline}">
            ${region.name.toUpperCase()}
          </div>
          <div class="mp" style="font-size:12px; font-weight:400;">OR ${region.orMp}</div>
        </div>
      `,
      iconSize: [160, 56],
      iconAnchor: [80, 28]
    });

    L.marker([centerLat, centerLng], { icon: label, interactive: false }).addTo(map);
  });

  // WA milepost dots
  const waMileposts = [
    [45.57717178924209,-122.35811811197887],
    [45.574387761696784,-122.3379418412744],
    [45.57168228259249,-122.31767443196766],
    [45.57127220639611,-122.29728168335058],
    [45.56662016855476,-122.28364651408691],
    [45.56102985432937,-122.2648064079709],
    [45.55987555654134,-122.24444584401725],
    [45.563546995644884,-122.22584850425872],
    [45.56881153146473,-122.20815059798753],
    [45.57625116179588,-122.1948812590321],
    [45.58782267134967,-122.18630464115624],
    [45.58825536007553,-122.16609974089357],
    [45.59195290359837,-122.14659262563586],
    [45.59710166230987,-122.12852803177422],
    [45.601854978105294,-122.11017645875259],
    [45.605727794114244,-122.09108061962257],
    [45.608373125543146,-122.07105711483845],
    [45.61414966277425,-122.05274555501393],
    [45.619210771974366,-122.03358293760114],
    [45.629240677932046,-122.02097809898952],
    [45.63393398082312,-122.00438080356382],
    [45.641297586757716,-121.98685153906915],
    [45.64220821919827,-121.96677961536544],
    [45.64951931886706,-121.94904287216742],
    [45.648321602374466,-121.93099600994587],
    [45.65617832767022,-121.91073514798099],
    [45.668946076066796,-121.90845807532007],
    [45.68152986573188,-121.90298943893877],
    [45.69103306984549,-121.88781471673984],
    [45.69974151706166,-121.87148112660806],
    [45.70509547553369,-121.85306723383641],
    [45.71087162567625,-121.83622427154205],
    [45.715279382223784,-121.81894429372339],
    [45.716526362577184,-121.79921036743339],
    [45.71206514569416,-121.7797914377609],
    [45.70489285493854,-121.76203903069768],
    [45.70167029934382,-121.74262992437748],
    [45.69973025409696,-121.72350576850152],
    [45.699704252335636,-121.70305937526899],
    [45.70575289484854,-121.68423558294273],
    [45.70864499761105,-121.66591759680304],
    [45.711102556119016,-121.64669718084505],
    [45.710581978738816,-121.62616296526893],
    [45.718343960275924,-121.60924219124765],
    [45.72025488811939,-121.59012803507693],
    [45.722265292809496,-121.56985554692517],
    [45.72765260528266,-121.55209475672271],
    [45.72963737803033,-121.53140293916158],
    [45.727615420570615,-121.51163165533845],
    [45.724298674681016,-121.49155810306661],
    [45.718206262198706,-121.47325956592135],
    [45.7104105797022,-121.45599823894798],
    [45.703994276909825,-121.43744650185398],
    [45.699337591758976,-121.41840633504147],
    [45.69804374091309,-121.39816498920028],
    [45.70606758771083,-121.38168059602745],
    [45.70760302714283,-121.3630530003438],
    [45.710689763480865,-121.34319726342558],
    [45.70604154323586,-121.32367147360151],
    [45.70380413895675,-121.30364448196084],
    [45.69485318349111,-121.2876305177368],
    [45.68655730633151,-121.27157722256696],
    [45.682781778153846,-121.25181028011662],
    [45.677563634428665,-121.23259609277824],
    [45.67308449745963,-121.2130039110274],
    [45.66223209084683,-121.19965999390924],
    [45.65140060431303,-121.1861403015251],
    [45.648696510517674,-121.167103182581],
    [45.65020250758744,-121.14641883018363],
    [45.649309113450144,-121.1257925736987],
    [45.64851094716258,-121.10543183170215],
    [45.656260298101415,-121.08800058615506],
    [45.658735894829796,-121.06854601717106],
    [45.662306253667346,-121.0484940630549],
    [45.66562557987358,-121.02849241350205],
    [45.664617826928385,-121.00792995194746],
    [45.66415168604518,-120.98808466548833],
    [45.66331415366489,-120.96744960296935],
    [45.66535036542713,-120.94805657610306],
    [45.66500927556059,-120.92906520804219],
    [45.662683747518216,-120.9136562859803]
  ];

  waMileposts.forEach(coord => {
    L.circleMarker(coord, {
      radius: 3,
      fillColor: '#333',
      color: '#333',
      weight: 1,
      opacity: 0.7,
      fillOpacity: 0.7
    }).addTo(map);
  });

  // OR milepost dots
  const orMileposts = [
    [45.542793, -122.357188],
    [45.540271, -122.337076],
    [45.538604, -122.316992],
    [45.541172, -122.296971],
    [45.542157, -122.276385],
    [45.541866, -122.255748],
    [45.544564, -122.235618],
    [45.547529, -122.215554],
    [45.550315, -122.195508],
    [45.558654, -122.178792],
    [45.568446, -122.163491],
    [45.575403, -122.145424],
    [45.578871, -122.125362],
    [45.580907, -122.105380],
    [45.587166, -122.086879],
    [45.594439, -122.069067],
    [45.600035, -122.050092],
    [45.607963, -122.032953],
    [45.612646, -122.013550],
    [45.616340, -121.994552],
    [45.623606, -121.976910],
    [45.631198, -121.959552],
    [45.637058, -121.940799],
    [45.644672, -121.923621],
    [45.652721, -121.905223],
    [45.664094, -121.892925],
    [45.672351, -121.876802],
    [45.677007, -121.857613],
    [45.685607, -121.841617],
    [45.696333, -121.829110],
    [45.697018, -121.808457],
    [45.693033, -121.788757],
    [45.691140, -121.769114],
    [45.691402, -121.748737],
    [45.690516, -121.728403],
    [45.687028, -122.708922],
    [45.689882, -121.689176],
    [45.695693, -121.670960],
    [45.698887, -121.651161],
    [45.699556, -121.631085],
    [45.704448, -121.612027],
    [45.704976, -121.591550],
    [45.706994, -121.570834],
    [45.711123, -121.550949],
    [45.712805, -121.531039],
    [45.710647, -121.510860],
    [45.708906, -121.490056],
    [45.701180, -121.472791],
    [45.695982, -121.454016],
    [45.689231, -121.436949],
    [45.686840, -121.417015],
    [45.685640, -121.396617],
    [45.694785, -121.381291],
    [45.694976, -121.361576],
    [45.695311, -121.341708],
    [45.693892, -121.321515],
    [45.691353, -121.302840],
    [45.680275, -121.289807],
    [45.674445, -121.271807],
    [45.669684, -121.252290],
    [45.667192, -121.232009],
    [45.659326, -121.215812],
    [45.645668, -121.210042],
    [45.631717, -121.212813],
    [45.617825, -121.210379],
    [45.607299, -121.197596],
    [45.602106, -121.178854],
    [45.599856, -121.159004],
    [45.602783, -121.138649],
    [45.611328, -121.122887],
    [45.622518, -121.109971],
    [45.634045, -121.097645],
    [45.642044, -121.080632],
    [45.647729, -121.061967],
    [45.647758, -121.041268],
    [45.647371, -121.020606],
    [45.646632, -120.999999],
    [45.643615, -120.979140],
    [45.649191, -120.960305],
    [45.653007, -120.941882],
    [45.642003, -120.928308],
    [45.635525, -120.911525]
  ];

  orMileposts.forEach(coord => {
    L.circleMarker(coord, {
      radius: 3,
      fillColor: '#333',
      color: '#333',
      weight: 1,
      opacity: 0.7,
      fillOpacity: 0.7
    }).addTo(map);
  });
})();
</script>
