<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Columbia River Gorge — Region Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Montserrat, sans-serif; color:#333; font-size:13px; }
    #map { width: 100%; height: 100%; }

    /* Right-side legend (flat, compact) */
    .legend {
      position: absolute; top: 0; right: 0; z-index: 1000;
      background: #fff; border-left: 1px solid #ddd; border-bottom: 1px solid #ddd;
      width: 270px; max-height: 100%; padding: 10px 14px 14px 14px; overflow-y: auto; line-height: 1.4;
    }
    .legend h3 { margin: 0; font-size: 15px; font-weight: 600; border-bottom: 1px solid #ddd; padding-bottom: 6px; }
    .region-item { display:flex; align-items:center; margin:4px 0; }
    .color-box { width:12px; height:12px; margin-right:8px; border:1px solid #ccc; }
    .region-link { color:#06c; text-decoration:none; }
    .region-link:hover { text-decoration:underline; }

    .highlights { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 8px; }
    .highlights h4 { margin:0 0 6px 0; font-size:14px; font-weight:600; }
    .highlights p { margin:8px 0; }
    .highlights em { color:#666; }
    .highlights span { color:#555; }

    /* Popup styling: no scroll; we expand the band instead */
    .popup-wrap { max-width: 360px; }
    .popup-wrap h4 { margin: 0 0 6px 0; font-size: 14px; }
    .trail-list { margin: 0; padding-left: 18px; }
    .trail-list li { margin: 2px 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Legend -->
  <div class="legend" id="legend">
    <h3>Region Guide</h3>

    <div class="region-item">
      <div class="color-box" style="background:#4a90e2;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('west');return false;">West</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#7ed321;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('centralwest');return false;">Central West</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#f8e71c;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('central');return false;">Central</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#f5a623;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('centraleast');return false;">Central East</a>
    </div>
    <div class="region-item">
      <div class="color-box" style="background:#d0021b;"></div>
      <a href="#" class="region-link" onclick="zoomToRegion('east');return false;">East</a>
    </div>

    <div class="highlights">
      <h4>Region Highlights</h4>

      <p><strong>West</strong><br>
      <em>Troutdale → Bridal Veil area</em><br>
      <span>I-84 Mile Markers (approx): 17–28</span><br>
      Waterfalls and short scenic hikes; historic Columbia River Highway viewpoints; lush mossy forests; easy access from Portland; family-friendly trails like Latourell and Bridal Veil Falls.</p>

      <p><strong>Central West</strong><br>
      <em>Wahkeena → Cascade Locks</em><br>
      <span>I-84 Mile Markers (approx): 28–41</span><br>
      Iconic waterfall corridor (Multnomah, Wahkeena, Horsetail); steep canyon hikes with sweeping vistas; Benson Bridge photo stops; Gorge Trail 400 connections; picnic areas and visitor centers.</p>

      <p><strong>Central</strong><br>
      <em>Cascade Locks → Starvation Creek</em><br>
      <span>I-84 Mile Markers (approx): 41–55</span><br>
      Forest climbs and summit routes (Hamilton Mountain, Table Mountain, Dog Mountain); panoramic viewpoints; Pacific Crest Trail crossings; windsurfing at Bridge of the Gods; spring wildflowers.</p>

      <p><strong>Central East</strong><br>
      <em>Starvation Creek → Mosier</em><br>
      <span>I-84 Mile Markers (approx): 55–67</span><br>
      Steep basalt cliffs and open hillsides; scenic drives with river overlooks; lesser-traveled trails like McCall Point and Coyote Wall; spring wildflowers; transition zone between rainforest and grassland.</p>

      <p><strong>East</strong><br>
      <em>Mosier → The Dalles and beyond</em><br>
      <span>I-84 Mile Markers (approx): 60–90</span><br>
      Drier climate with high-desert scenery; oak woodlands and wide-open ridges; wildflower plateaus; biking and wine-tasting routes near Rowena and Mosier; sunny weather and sweeping Gorge views.</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --------------------
    // Map setup
    // --------------------
    const map = L.map('map', { center: [45.68, -121.8], zoom: 9.45 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --------------------
    // Trail data (embedded)
    // --------------------
    const TRAILS = {
      "West": [
        "Angels’ Rest","Angels’ Rest to Devil’s Rest","Bridal Veil Falls","Bridal Veil Loop",
        "Fairy Falls","Larch Mt via Multnomah Falls","Latourell Falls Trail",
        "Multnomah Falls","Multnomah–Wahkeena Loop","Rooster Rock Loop","Sandy River Delta",
        "Shepperd's Dell","Wahkeena Falls"
      ],
      "Central West": [
        "Bell Creek Trail","Eagle Creek Trail","Elowah Falls","Horsetail Falls Loop",
        "Indian Point Loop","John B. Yeon Trailhead","Munra Point","Nesmith Point Trail",
        "Oneonta Gorge","Ponytail Falls Trail","Punchbowl Falls","Triple Falls Trail",
        "Tunnel Falls","Upper McCord Creek Falls","Wauna Point"
      ],
      "Central": [
        "Bonneville Dam Trail","Bridge Of The Gods Trailhead","Cascade Locks Trail",
        "Dry Creek Falls","Hamilton Mountain Loop","Hardy Ridge Loop","Herman Creek Pinnacles",
        "Nick Eaton Ridge Loop","Ruckel Ridge Loop","Table Mountain Loop","Tom McCall Point",
        "Wahclella Falls"
      ],
      "Central East": [
        "Chetwoot Loop Hike","Lancaster Falls","Lower Starvation Loop","Mark O. Hatfield Trailhead",
        "Memaloose Hills","Mitchell Point Trail","Mosier Twin Tunnels","Mt. Defiance Loop",
        "Rowena Plateau","Starvation Creek Trail","Starvation Ridge","Tooth Rock Loop","Wygant Peak"
      ],
      "East": [
        "Augspurger Mountain Trail","Beacon Rock Trail","Cape Horn Loop Trail",
        "Catherine Creek Arch Loop","Columbia Hills State Park","Coyote Wall","Deschutes River Trail",
        "Dog Mountain","Gillette Lake","Horsethief Butte Trail","Klickitat Rail Trail",
        "Labyrinth / Syncline","Lyle Cherry Orchard","Sevenmile Hill","Steigerwald Lake Trail",
        "The Dalles Mountain","Wind Mountain"
      ]
    };

    // --------------------
    // Region bands (river-centered)
    // --------------------
    const latCenter = 45.70;
    const baseHalf = 0.05;      // default half-height of each band (~5-6 km N/S)
    const topBase = latCenter + baseHalf;
    const botBase = latCenter - baseHalf;

    const slices = {
      west:       { minLon: -122.50, maxLon: -122.25, color: '#4a90e2', label: 'West' },
      centralwest:{ minLon: -122.25, maxLon: -122.00, color: '#7ed321', label: 'Central West' },
      central:    { minLon: -122.00, maxLon: -121.75, color: '#f8e71c', label: 'Central' },
      centraleast:{ minLon: -121.75, maxLon: -121.50, color: '#f5a623', label: 'Central East' },
      east:       { minLon: -121.50, maxLon: -121.25, color: '#d0021b', label: 'East' }
    };

    const regions = {};
    const baseCoords = {};
    const expandedState = { current: null };

    // Helper: build rectangle coords by half-height
    function rectCoords(minLon, maxLon, halfHeight) {
      return [
        [latCenter + halfHeight, minLon],
        [latCenter + halfHeight, maxLon],
        [latCenter - halfHeight, maxLon],
        [latCenter - halfHeight, minLon]
      ];
    }

    // Create base bands
    for (const key in slices) {
      const { minLon, maxLon, color } = slices[key];
      const coords = rectCoords(minLon, maxLon, baseHalf);
      baseCoords[key] = coords.slice();
      const poly = L.polygon(coords, { color, weight: 1, fillColor: color, fillOpacity: 0.25 });
      poly.addTo(map);
      regions[key] = poly;
    }

    // --------------------
    // Popups + expansion logic
    // --------------------
    const mapKeyToLabel = {
      west: 'West',
      centralwest: 'Central West',
      central: 'Central',
      centraleast: 'Central East',
      east: 'East'
    };

    // Render popup HTML
    function popupHTML(regionLabel) {
      const list = TRAILS[regionLabel] || [];
      const items = list.map(t => `<li>${escapeHTML(t)}</li>`).join('');
      return `
        <div class="popup-wrap">
          <h4>${regionLabel} — Trails (${list.length})</h4>
          <ol class="trail-list">${items}</ol>
        </div>
      `;
    }

    // Estimate extra half-height needed based on trail count (rough heuristic)
    // Each item ~16px line-height; convert to degrees lat so all items fit without scroll.
    function extraHalfHeightFor(count) {
      // Heuristic: ~0.002 deg per 5 items; scale gently so it doesn’t get absurdly tall.
      return Math.min(0.18, (count / 5) * 0.002);
    }

    // Expand a region (increase band height), bind and open popup
    function expandRegion(key) {
      const label = mapKeyToLabel[key];
      const band = regions[key];
      const { minLon, maxLon } = slices[key];
      const trailCount = (TRAILS[label] || []).length;

      // Reset others first
      resetAllBands();

      // Compute expanded half-height so the trail list fits comfortably
      const extra = extraHalfHeightFor(trailCount);
      const newCoords = rectCoords(minLon, maxLon, baseHalf + extra);
      band.setLatLngs(newCoords);

      // Bind & open popup (no internal scroll—band is taller instead)
      band.bindPopup(popupHTML(label), { maxWidth: 360, closeButton: true }).openPopup();
      expandedState.current = key;
    }

    // Reset all bands to base size & close popups
    function resetAllBands() {
      for (const k in regions) {
        regions[k].setLatLngs(baseCoords[k]);
        regions[k].closePopup();
      }
      expandedState.current = null;
    }

    // Click handlers: expand on band click, reset on map click
    for (const key in regions) {
      regions[key].on('click', (e) => {
        L.DomEvent.stopPropagation(e); // prevent map click from immediately resetting
        expandRegion(key);
      });
    }
    map.on('click', resetAllBands);

    // Public helper for legend links
    function zoomToRegion(regionKey) {
      const layer = regions[regionKey];
      if (layer) {
        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        // Also expand & show trails when using legend links (feels intentional)
        expandRegion(regionKey);
      }
    }
    window.zoomToRegion = zoomToRegion;

    // Utility
    function escapeHTML(s) {
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
  </script>
</body>
</html>
