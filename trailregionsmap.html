<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Columbia River Gorge — Region Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{
      height:100%;width:100%;margin:0;padding:0;
      font-family:Montserrat,sans-serif;color:#333;font-size:13px;
      border:none;
    }
    .container{
      display:flex;
      width:100%;
      height:100%;
      gap:0;
      border:none;
      margin:0;
      padding:0;
    }
    .map-column{
      flex:1;
      position:relative;
      box-sizing:border-box;
      border:1px solid #ddd;
      margin:0;
      padding:0;
    }
    #map{
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      border:none;
    }
    .legend-column{
      width:320px;
      background:#fff;
      padding:10px 14px 14px 14px;
      overflow-y:auto;
      line-height:1.45;
      box-sizing:border-box;
      border:none;
      margin:0;
    }
    .legend-column h3{margin:0 0 16px 0;font-family:Montserrat,sans-serif;font-style:normal;font-weight:300;font-size:32px;line-height:48px;color:#2e2e2e;}
    .region-entry{margin:12px 0 8px 0;padding-bottom:12px;border-bottom:1px solid #ddd;}
    .region-entry:last-child{border-bottom:none;}
    .region-link{
      text-decoration:none;font-weight:700;font-size:18px;
      display:inline-block;margin-bottom:0;cursor:pointer;
    }
    .region-link:hover{opacity:0.75;}
    .region-meta{margin:4px 0 0 2px;color:#555;}
    .region-meta div{margin:0 0 4px 0;}
    .region-meta div:last-child{margin-bottom:0;}
    .legend-detail .back-row{position:sticky;top:0;background:#fff;padding:0 0 47.5px 0;z-index:2;margin-bottom:0;}
    .legend-detail .back-link{color:#06c;text-decoration:none;font-weight:600;cursor:pointer;}
    .legend-detail .back-link:hover{text-decoration:underline;}
    .legend-detail h3{font-size:18px;font-weight:700;margin:0 0 5.5px 0;line-height:1.2;}
    .legend-detail .region-info{color:#555;margin-bottom:8px;margin-left:2px;}
    .legend-detail .region-info div{margin:0 0 4px 0;line-height:1.5;}
    .legend-detail .region-info div:last-child{margin-bottom:0;}
    .trail-list{margin:10px 0 0 0;padding-left:18px;list-style-type:disc;}
    .trail-list li{margin:3px 0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="map-column">
      <div id="map"></div>
    </div>
    <div class="legend-column" id="legend"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    (function() {
      'use strict';
      
      // Wait for both DOM and Leaflet to be ready
      function waitForLeaflet(callback) {
        if (typeof L !== 'undefined') {
          callback();
        } else {
          setTimeout(function() { waitForLeaflet(callback); }, 50);
        }
      }
      
      function initWhenReady() {
        waitForLeaflet(function() {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGorge);
          } else {
            initGorge();
          }
        });
      }
      
      var gorge = {};
      
      gorge.DEFAULT_CENTER = [45.6746, -121.8794];
      gorge.DEFAULT_ZOOM = 9.4;

      gorge.REGION_INFO = {
        west:{label:'West',color:'#1B5E20',area:'Portland metro → Bridal Veil',mm:'17–28',
          highlights:'Waterfalls and short scenic hikes; historic Columbia River Highway viewpoints; lush mossy forests; easy access from Portland; family-friendly trails like Latourell and Bridal Veil Falls.'},
        centralwest:{label:'Central West',color:'#2E7D32',area:'Bridal Veil → Elowah Falls',mm:'28–40',
          highlights:'Iconic waterfall corridor (Multnomah, Wahkeena, Horsetail); steep canyon hikes with sweeping vistas; Benson Bridge photo stops; Gorge Trail 400 connections; picnic areas and visitor centers.'},
        central:{label:'Central',color:'#558B2F',area:'Bonneville Dam → Dog Mountain',mm:'40–51',
          highlights:'Forest climbs and summit routes (Hamilton Mountain, Table Mountain, Dog Mountain); panoramic viewpoints; Pacific Crest Trail crossings; Bridge of the Gods; Beacon Rock; spring wildflowers.'},
        centraleast:{label:'Central East',color:'#9E9D24',area:'Herman Creek → Hood River',mm:'51–64',
          highlights:'Steep basalt cliffs and open hillsides; scenic drives with river overlooks; lesser-traveled trails like Wyeth and Mitchell Point; spring wildflowers; transition zone between rainforest and grassland.'},
        east:{label:'East',color:'#C0CA33',area:'Mosier → The Dalles',mm:'64–90',
          highlights:'Drier climate with high-desert scenery; oak woodlands and wide-open ridges; wildflower plateaus; biking and wine-tasting routes near Rowena and Mosier; sunny weather and sweeping Gorge views.'}
      };

      gorge.TRAILS = {
        "West":["Angels' Rest","Angels' Rest to Devil's Rest","Bridal Veil Falls","Bridal Veil Loop","Cape Horn Loop Trail","Coopey Falls","Devils Rest","Fairy Falls","Franklin Ridge","Gorge Trail #400","Larch Mt via Multnomah Falls","Latourell Falls Trail","Multnomah Falls","Multnomah–Wahkeena Loop","Rooster Rock Loop","Sandy River Delta","Shepperd's Dell","Wahkeena Falls","Washougal Waterfront Trail"],
        "Central West":["Aldrich Butte","Bell Creek Trail","Dry Creek Falls","Eagle Creek Trail","Elowah Falls","Horsetail Falls Loop","Indian Point Loop","John B. Yeon Trailhead","Munra Point","Nesmith Point Trail","Oneonta Gorge","Ponytail Falls Trail","Pool Of The Winds","Punchbowl Falls","Tanner Butte Trail","Tanner Ridge","Triple Falls Trail","Tunnel Falls","Upper McCord Creek Falls","Wauna Point","Wauna Viewpoint"],
        "Central":["Beacon Rock Trail","Benson Plateau","Bonneville Dam Trail","Bridge Of The Gods Trailhead","Cascade Locks Trail","Dog Mountain","Falls Creek Falls","Fort Cascades Loop","Hamilton Mountain Loop","Hardy Ridge Loop","Heartbreak Ridge","Herman Creek Pinnacles","Nick Eaton Ridge Loop","Ruckel Ridge Loop","Strawberry Island","Table Mountain Loop","Tamanous Trail","Tom McCall Point","Wahclella Falls"],
        "Central East":["Cabin Creek Falls","Chetwoot Loop Hike","Hole-in-the-Wall Falls","Lancaster Falls","Lower Starvation Loop","Mark O. Hatfield Trailhead","Memaloose Hills","Mitchell Point Trail","Mosier Creek Falls","Mosier Plateau","Mosier Twin Tunnels","Mt. Defiance Loop","North Lake","Rowena Plateau","Starvation Creek Trail","Starvation Ridge","Tooth Rock Loop","Wahtum Lake","Wyeth Trail","Wygant Peak"],
        "East":["Augspurger Mountain Trail","Balfour-Klickitat Loop","Catherine Creek Arch Loop","Columbia Hills State Park","Coyote Wall","Crawford Oaks","Deschutes River Trail","Dog Creek Falls","Ferry Springs Trail","Gillette Lake","Horsethief Butte Trail","Klickitat Rail Trail","Labyrinth / Syncline","Lyle Cherry Orchard","Sevenmile Hill","Steigerwald Lake Trail","The Dalles Mountain","The Dalles Riverfront Trail","Wind Mountain"]
      };

      gorge.REGION_CENTER_LAT = {
        west:45.55,
        centralwest:45.58,
        central:45.655,
        centraleast:45.685,
        east:45.68
      };

      gorge.baseHalf = 0.045;
      gorge.slices = {
        west:{minLon:-122.50,maxLon:-122.15},
        centralwest:{minLon:-122.15,maxLon:-121.88},
        central:{minLon:-121.88,maxLon:-121.60},
        centraleast:{minLon:-121.60,maxLon:-121.38},
        east:{minLon:-121.38,maxLon:-121.10}
      };

      gorge.regions = {};
      gorge.baseCoords = {};
      gorge.regionLayers = {};
      gorge.regionLabels = {};
      
      function initGorge() {
        try {
          gorge.map = L.map('map').setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);

          L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
            { attribution: '&copy; Esri, USGS, NOAA, U.S. Navy, NGA, GEBCO' }
          ).addTo(gorge.map);

          gorge.legend = document.getElementById('legend');
          
          createRegions();
          setupEventListeners();
          renderGuide();
        } catch (e) {
          console.error('Initialization error:', e);
        }
      }

      function rectCoordsFor(key, minLon, maxLon, half) {
        var c = gorge.REGION_CENTER_LAT[key];
        return [[c+half,minLon],[c+half,maxLon],[c-half,maxLon],[c-half,minLon]];
      }

      function createRegions() {
        var borderColor = '#666';
        
        for(var k in gorge.slices) {
          var i = gorge.REGION_INFO[k];
          var s = gorge.slices[k];
          var coords = rectCoordsFor(k, s.minLon, s.maxLon, gorge.baseHalf);
          gorge.baseCoords[k] = coords.slice();
          
          gorge.regionLayers[k] = [];
          
          var fadeSteps = 5;
          var fadeExtensionLat = 0.03;
          var centerLat = gorge.REGION_CENTER_LAT[k];
          
          for(var step = 1; step <= fadeSteps; step++) {
            var topStart = centerLat + gorge.baseHalf + (fadeExtensionLat * (step - 1));
            var topEnd = centerLat + gorge.baseHalf + (fadeExtensionLat * step);
            var opacity = 0.35 - (0.35 * (step / fadeSteps));
            
            var layer = L.polygon([
              [topEnd, s.minLon],
              [topEnd, s.maxLon],
              [topStart, s.maxLon],
              [topStart, s.minLon]
            ], {
              color: 'transparent',
              fillColor: i.color,
              weight: 0,
              fillOpacity: opacity,
              interactive: false
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          for(var step = 1; step <= fadeSteps; step++) {
            var bottomStart = centerLat - gorge.baseHalf - (fadeExtensionLat * (step - 1));
            var bottomEnd = centerLat - gorge.baseHalf - (fadeExtensionLat * step);
            var opacity = 0.35 - (0.35 * (step / fadeSteps));
            
            var layer = L.polygon([
              [bottomStart, s.minLon],
              [bottomStart, s.maxLon],
              [bottomEnd, s.maxLon],
              [bottomEnd, s.minLon]
            ], {
              color: 'transparent',
              fillColor: i.color,
              weight: 0,
              fillOpacity: opacity,
              interactive: false
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          var borderSteps = 10;
          var totalHeight = gorge.baseHalf * 2 + (fadeExtensionLat * fadeSteps * 2);
          var startLat = centerLat - gorge.baseHalf - (fadeExtensionLat * fadeSteps);
          
          for(var bstep = 0; bstep < borderSteps; bstep++) {
            var latStart = startLat + (totalHeight * bstep / borderSteps);
            var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
            var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
            var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
            var borderOpacity = 1 - (distFromCenter / maxDist);
            borderOpacity = Math.max(0, Math.min(1, borderOpacity));
            
            var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
              color: borderColor,
              weight: 2,
              opacity: borderOpacity
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          for(var bstep = 0; bstep < borderSteps; bstep++) {
            var latStart = startLat + (totalHeight * bstep / borderSteps);
            var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
            var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
            var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
            var borderOpacity = 1 - (distFromCenter / maxDist);
            borderOpacity = Math.max(0, Math.min(1, borderOpacity));
            
            var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
              color: borderColor,
              weight: 2,
              opacity: borderOpacity
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          gorge.regions[k] = L.polygon(coords, {
            color: 'transparent',
            fillColor: i.color,
            weight: 0,
            fillOpacity: 0.35
          }).addTo(gorge.map);
          
          var labelIcon = L.divIcon({
            className: 'region-label',
            html: '<div style="font-size:16px;font-weight:700;color:'+i.color+';text-shadow:1px 1px 2px rgba(255,255,255,0.9), -1px -1px 2px rgba(255,255,255,0.9), 1px -1px 2px rgba(255,255,255,0.9), -1px 1px 2px rgba(255,255,255,0.9);white-space:nowrap;text-align:center;">'+i.label+'</div>',
            iconSize: [100, 0],
            iconAnchor: [50, 0]
          });
          
          gorge.regionLabels[k] = L.marker([centerLat, (s.minLon + s.maxLon) / 2], {
            icon: labelIcon,
            interactive: false
          }).addTo(gorge.map);
        }
      }

      function resetBands() {
        for(var k in gorge.regions) {
          for(var j = 0; j < gorge.regionLayers[k].length; j++) {
            if(gorge.map.hasLayer(gorge.regionLayers[k][j])) {
              gorge.map.removeLayer(gorge.regionLayers[k][j]);
            }
          }
          gorge.regionLayers[k] = [];
          
          var i = gorge.REGION_INFO[k];
          var s = gorge.slices[k];
          var borderColor = '#666';
          var fadeSteps = 5;
          var fadeExtensionLat = 0.03;
          var centerLat = gorge.REGION_CENTER_LAT[k];
          
          for(var step = 1; step <= fadeSteps; step++) {
            var topStart = centerLat + gorge.baseHalf + (fadeExtensionLat * (step - 1));
            var topEnd = centerLat + gorge.baseHalf + (fadeExtensionLat * step);
            var opacity = 0.35 - (0.35 * (step / fadeSteps));
            
            var layer = L.polygon([
              [topEnd, s.minLon],
              [topEnd, s.maxLon],
              [topStart, s.maxLon],
              [topStart, s.minLon]
            ], {
              color: 'transparent',
              fillColor: i.color,
              weight: 0,
              fillOpacity: opacity,
              interactive: false
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          for(var step = 1; step <= fadeSteps; step++) {
            var bottomStart = centerLat - gorge.baseHalf - (fadeExtensionLat * (step - 1));
            var bottomEnd = centerLat - gorge.baseHalf - (fadeExtensionLat * step);
            var opacity = 0.35 - (0.35 * (step / fadeSteps));
            
            var layer = L.polygon([
              [bottomStart, s.minLon],
              [bottomStart, s.maxLon],
              [bottomEnd, s.maxLon],
              [bottomEnd, s.minLon]
            ], {
              color: 'transparent',
              fillColor: i.color,
              weight: 0,
              fillOpacity: opacity,
              interactive: false
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          var borderSteps = 10;
          var totalHeight = gorge.baseHalf * 2 + (fadeExtensionLat * fadeSteps * 2);
          var startLat = centerLat - gorge.baseHalf - (fadeExtensionLat * fadeSteps);
          
          for(var bstep = 0; bstep < borderSteps; bstep++) {
            var latStart = startLat + (totalHeight * bstep / borderSteps);
            var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
            var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
            var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
            var borderOpacity = 1 - (distFromCenter / maxDist);
            borderOpacity = Math.max(0, Math.min(1, borderOpacity));
            
            var layer = L.polyline([[latStart, s.minLon], [latEnd, s.minLon]], {
              color: borderColor,
              weight: 2,
              opacity: borderOpacity
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          for(var bstep = 0; bstep < borderSteps; bstep++) {
            var latStart = startLat + (totalHeight * bstep / borderSteps);
            var latEnd = startLat + (totalHeight * (bstep + 1) / borderSteps);
            var distFromCenter = Math.abs((latStart + latEnd) / 2 - centerLat);
            var maxDist = gorge.baseHalf + (fadeExtensionLat * fadeSteps);
            var borderOpacity = 1 - (distFromCenter / maxDist);
            borderOpacity = Math.max(0, Math.min(1, borderOpacity));
            
            var layer = L.polyline([[latStart, s.maxLon], [latEnd, s.maxLon]], {
              color: borderColor,
              weight: 2,
              opacity: borderOpacity
            }).addTo(gorge.map);
            gorge.regionLayers[k].push(layer);
          }
          
          gorge.regions[k].setLatLngs(gorge.baseCoords[k]);
          gorge.regions[k].setStyle({fillOpacity: 0.35});
        }
      }

      function escapeHTML(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function renderGuide(resetView) {
        gorge.legend.className = 'legend-column';
        var html = '<h3>Region Guide</h3>';
        for(var k in gorge.REGION_INFO) {
          var i = gorge.REGION_INFO[k];
          html += '<div class="region-entry"><a class="region-link" style="color:'+i.color+';" data-region="'+k+'">'+i.label+'</a><div class="region-meta"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div></div></div>';
        }
        gorge.legend.innerHTML = html;
        
        var links = gorge.legend.querySelectorAll('.region-link');
        for(var i=0; i<links.length; i++) {
          links[i].onclick = function() {
            showRegion(this.getAttribute('data-region'));
          };
        }
        
        if(resetView) {
          gorge.map.setView(gorge.DEFAULT_CENTER, gorge.DEFAULT_ZOOM);
        }
      }

      function renderRegionDetail(k) {
        var i = gorge.REGION_INFO[k];
        var trails = (gorge.TRAILS[i.label] || []).slice().sort(function(a,b){return a.localeCompare(b);});
        gorge.legend.className = 'legend-column legend-detail';
        var html = '<div class="back-row"><a class="back-link" id="backLink">← Back to Region Guide</a></div><h3 style="color:'+i.color+';">'+i.label+'</h3><div class="region-info"><div><strong>Area:</strong> '+i.area+'</div><div><strong>I-84 Mile Range:</strong> '+i.mm+'</div><div><strong>Highlights:</strong> '+i.highlights+'</div></div><ul class="trail-list">';
        for(var j=0; j<trails.length; j++) {
          html += '<li>'+escapeHTML(trails[j])+'</li>';
        }
        html += '</ul>';
        gorge.legend.innerHTML = html;
        
        document.getElementById('backLink').onclick = function() {
          backToGuide();
        };
      }

      function showRegion(k) {
        for(var rk in gorge.regions) {
          if(gorge.map.hasLayer(gorge.regions[rk])) {
            gorge.map.removeLayer(gorge.regions[rk]);
          }
          if(gorge.map.hasLayer(gorge.regionLabels[rk])) {
            gorge.map.removeLayer(gorge.regionLabels[rk]);
          }
          if(gorge.regionLayers[rk]) {
            for(var j = 0; j < gorge.regionLayers[rk].length; j++) {
              if(gorge.map.hasLayer(gorge.regionLayers[rk][j])) {
                gorge.map.removeLayer(gorge.regionLayers[rk][j]);
              }
            }
          }
        }
        
        var i = gorge.REGION_INFO[k];
        var s = gorge.slices[k];
        var count = (gorge.TRAILS[i.label] || []).length;
        var half = gorge.baseHalf + Math.min(0.12, (count/6)*0.002);
        var centerLat = gorge.REGION_CENTER_LAT[k];
        
        if(!gorge.expandedLayers) gorge.expandedLayers = {};
        if(gorge.expandedLayers[k]) {
          for(var j = 0; j < gorge.expandedLayers[k].length; j++) {
            if(gorge.map.hasLayer(gorge.expandedLayers[k][j])) {
              gorge.map.removeLayer(gorge.expandedLayers[k][j]);
            }
          }
        }
        gorge.expandedLayers[k] = [];
        
        var lines = [
          [[centerLat + half, s.minLon], [centerLat + half, s.maxLon]],
          [[centerLat - half, s.minLon], [centerLat - half, s.maxLon]],
          [[centerLat + half, s.minLon], [centerLat - half, s.minLon]],
          [[centerLat + half, s.maxLon], [centerLat - half, s.maxLon]]
        ];
        
        for(var b = 0; b < lines.length; b++) {
          var line = L.polyline(lines[b], {
            color: i.color,
            weight: 3,
            opacity: 0.8
          }).addTo(gorge.map);
          gorge.expandedLayers[k].push(line);
        }
        
        renderRegionDetail(k);
        
        var bounds = [
          [centerLat + half, s.minLon],
          [centerLat - half, s.maxLon]
        ];
        gorge.map.fitBounds(bounds, {padding: [20, 20]});
      }
      
      function backToGuide() {
        if(gorge.expandedLayers) {
          for(var k in gorge.expandedLayers) {
            for(var j = 0; j < gorge.expandedLayers[k].length; j++) {
              if(gorge.map.hasLayer(gorge.expandedLayers[k][j])) {
                gorge.map.removeLayer(gorge.expandedLayers[k][j]);
              }
            }
          }
        }
        
        for(var k in gorge.regions) {
          if(!gorge.map.hasLayer(gorge.regions[k])) {
            gorge.map.addLayer(gorge.regions[k]);
            gorge.map.addLayer(gorge.regionLabels[k]);
          }
        }
        
        resetBands();
        renderGuide(true);
      }

      function setupEventListeners() {
        gorge.map.on('click', function() {
          backToGuide();
        });
        
        for(var k in gorge.regions) {
          (function(key) {
            gorge.regions[key].on('click', function(e) {
              L.DomEvent.stopPropagation(e);
              showRegion(key);
            });
          })(k);
        }
      }

      initWhenReady();
    })();
  </script>
</body>
</html>
